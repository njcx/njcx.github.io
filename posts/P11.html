<!DOCTYPE html>
<html lang="zh">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="GgupatpoZgdqsBlxEZoMqGAy3aXAFtXIrYged3SB6EA" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>使用Sysmon和Winlogbeat打造Windows平台的HIDS | nJcx's Blog
</title>
  <link rel="canonical" href="https://www.njcx.bid/posts/P11.html">


  <link rel="apple-touch-icon" href="https://www.njcx.bid/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://www.njcx.bid/manifest.json">
  <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/pygments/emacs.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/style.css">


<meta name="description" content="使用Sysmon和Winlogbeat打造Windows平台的HIDS~">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a34c7a96ae9745547c373575407c521f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-4">
          <a href="https://www.njcx.bid">
            <img class="img-fluid" src=https://www.njcx.bid/images/profile.png width=200 height=200 alt="nJcx's Blog">
          </a>
        </div>
        <div class="col-sm-8">
          <h1 class="title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.njcx.bid">nJcx's Blog</a></h1>
          <p class="text-muted">十年生死两茫茫，写程序，到天亮。相顾无言，惟有泪千行</p>
          <ul class="list-inline">
                    <li class="list-inline-item">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.zhihu.com/people/njcxs" target="_blank">知乎</a></li>
                <li class="list-inline-item"><a href="https://www.facebook.com/nJcx1" target="_blank">FaceBook</a></li>
                <li class="list-inline-item"><a href="https://github.com/njcx" target="_blank">Github</a></li>
            <li class=" list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/njcx" target="_blank"></a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>使用Sysmon和Winlogbeat打造Windows平台的HIDS
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-08-02T20:20:00+03:00">
        <i class="fa fa-clock-o"></i>
        Thu 02 August 2018
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://www.njcx.bid/category/an-quan.html">安全</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://www.njcx.bid/author/njcx.html">nJcx</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://www.njcx.bid/tag/hids.html">#HIDS</a>      </li>
    </ul>
  </header>
  <div class="content">
    <h4>介绍</h4>
<div class="highlight"><pre><span></span>https://docs.microsoft.com/zh-cn/sysinternals/downloads/sysmon
</pre></div>
<p>Sysmon是微软的一款免费的轻量级系统监控工具。它通过系统服务和驱动程序实现记录进程创建，网络连接以及文件创建时间更改的详细信息，并把相关的信息写入并展示在windows的日志事件里。我们可以通过读取Windows的日志，了解Windows的安全状态。</p>
<p>Sysmon安装后分为用户态系统服务，即ring3层的exe， 驱动（Flt的minifilter）两部分，下面开始上篇的讲解，ring3实现对网络数据记录以及对驱动返回的数据进行解析，而驱动部分则返回进程相关的信息以及进程访问文件注册表的数据给ring3，我们首选讲解ring3的实现原理。用户态通过ETW(Event Tracing for Windows)实现对网络数据记录，通过EventLog对驱动返回的数据进行解析，驱动部分则通过进、线程，模块的回调函数收集进程相关的信息，通过Minifilter文件过滤驱动和注册表回调函数记录访问文件、注册表的数据。</p>
<p>从功能上来讲，Sysmon是一款优秀的HIDS、EDR的主机入侵检测引擎，其依托于Windows内核层进、线程，模块，注册表回调，及文件过滤驱动针对相应的行为进行实时的增、删、改信息收集并通过ETW存储并展示于Windows日志。</p>
<h4>安装</h4>
<p>下载地址</p>
<div class="highlight"><pre><span></span>https://download.sysinternals.com/files/Sysmon.zip
</pre></div>
<div class="highlight"><pre><span></span>    Install:    Sysmon.exe -i &lt;configfile&gt;
    <span class="o">[</span>-h &lt;<span class="o">[</span>sha1<span class="p">|</span>md5<span class="p">|</span>sha256<span class="p">|</span>imphash<span class="p">|</span>*<span class="o">]</span>,...&gt;<span class="o">]</span> <span class="o">[</span>-n <span class="o">[</span>&lt;process,...&gt;<span class="o">]]</span>
    <span class="o">[</span>-l <span class="o">(</span>&lt;process,...&gt;<span class="o">)]</span>

    Configure:  Sysmon.exe -c &lt;configfile&gt;
                  <span class="o">[</span>--<span class="p">|</span><span class="o">[</span>-h &lt;<span class="o">[</span>sha1<span class="p">|</span>md5<span class="p">|</span>sha256<span class="p">|</span>imphash<span class="p">|</span>*<span class="o">]</span>,...&gt;<span class="o">]</span> <span class="o">[</span>-n <span class="o">[</span>&lt;process,...&gt;<span class="o">]]</span>
                   <span class="o">[</span>-l <span class="o">[</span>&lt;process,...&gt;<span class="o">]]]</span>

    Uninstall:  Sysmon.exe -u
</pre></div>
<p>-c 更新或显示配置</p>
<p>-h 指定hash记录的算法</p>
<p>-i 安装，可用xml文件来更新配置文件</p>
<p>-l 记录加载模块，可指定进程</p>
<p>-m 安装事件清单</p>
<p>-n 记录网络链接</p>
<p>-r 检测证书是否撤销</p>
<p>-u 卸载服务和驱动</p>
<p>一键安装：</p>
<p>sysmon -accepteula  –i -n
指定配置文件（安装时请用-i）</p>
<p>sysmon -c xxx.xml
注：安装需要管理员权限并重启，windows 7 或者以上，服务器系统windows server 2012 及以上。   </p>
<p>配置样例</p>
<div class="highlight"><pre><span></span> &lt;Sysmon <span class="nv">schemaversion</span><span class="o">=</span><span class="s2">"4.21"</span>&gt;
&lt;!-- Capture all hashes --&gt;
&lt;HashAlgorithms&gt;*&lt;/HashAlgorithms&gt; &lt;!--哈希配置<span class="o">(</span>默认使用sha1<span class="o">)</span> --&gt;
&lt;EventFiltering&gt; &lt;!--事件筛选--&gt;
&lt;!-- Log all drivers except <span class="k">if</span> the signature --&gt;
&lt;!-- contains Microsoft or Windows --&gt;
&lt;DriverLoad <span class="nv">onmatch</span><span class="o">=</span><span class="s2">"exclude"</span>&gt; &lt;!--默认记录所有日志 除非标记 ? --&gt;
     &lt;Signature <span class="nv">condition</span><span class="o">=</span><span class="s2">"contains"</span>&gt;microsoft&lt;/Signature&gt;
     &lt;Signature <span class="nv">condition</span><span class="o">=</span><span class="s2">"contains"</span>&gt;windows&lt;/Signature&gt;
&lt;/DriverLoad&gt;
&lt;!-- Do not log process termination --&gt;
&lt;!--不记录进程终止--&gt;
&lt;ProcessTerminate <span class="nv">onmatch</span><span class="o">=</span><span class="s2">"include"</span> /&gt;
&lt;!-- Log network connection <span class="k">if</span> the destination port equal <span class="m">443</span> --&gt;
&lt;!-- or <span class="m">80</span>, and process isn<span class="err">'</span>t InternetExplorer --&gt;
&lt;NetworkConnect <span class="nv">onmatch</span><span class="o">=</span><span class="s2">"include"</span>&gt;
     &lt;DestinationPort&gt;443&lt;/DestinationPort&gt; &lt;!-- 记录443 端口连接记录--&gt;
     &lt;DestinationPort&gt;80&lt;/DestinationPort&gt;
&lt;/NetworkConnect&gt;
&lt;NetworkConnect <span class="nv">onmatch</span><span class="o">=</span><span class="s2">"exclude"</span>&gt;
     &lt;Image <span class="nv">condition</span><span class="o">=</span><span class="s2">"end with"</span>&gt;iexplore.exe&lt;/Image&gt;
&lt;/NetworkConnect&gt;
&lt;/EventFiltering&gt;
&lt;/Sysmon&gt;
 -- 配置条目直接位于Sysmon 标签下, 过滤器位于 EventFiltering 标签下 
</pre></div>
<p>一些配置规则</p>
<div class="highlight"><pre><span></span> https://github.com/sametsazak/sysmon.git

 https://github.com/SwiftOnSecurity/sysmon-config

 https://github.com/ion-storm/sysmon-config
</pre></div>
<div class="highlight"><pre><span></span> ProcessCreate            进程创建
 FileCreateTime           文件创建时间更改
 NetworkConnect           检测到网络连接
 ProcessTerminate         进程终止
 DriverLoad               驱动程序已加载
 ImageLoad                镜像加载
 CreateRemoteThread       已检测到创建远程线程
 RawAccessRead            检测到原始访问读取
 ProcessAccess            已访问的进程
 FileCreate               文件创建
 RegistryEvent            添加或删除注册表对象
 RegistryEvent            注册表值设置
 RegistryEvent            注册表对象已重命名
 FileCreateStreamHash     已创建文件流
 PipeEvent                管道创建
 PipeEvent                管道已连接
 WmiEvent                 检测到WmiEventFilter活动 -- WmiEventFilter activity detected
 WmiEvent                 检测到WmiEventConsumer活动 -- WmiEventConsumer activity detected
 WmiEvent                 检测到WmiEventConsumerToFilter活动 -- WmiEventConsumerToFilter activity 
 DnsQuery                 DNS查询
</pre></div>
<p>我们可以使用 winlogbeat采集到elk，也可以使用wazuh完成数据日志采集，然后用来分析</p>
<p>我们也可以使用一些工具辅助我们分析，如下：</p>
<p>Sysmon View：Sysmon日志可视化工具</p>
<p>Sysmon Shell：Sysmon配置文件生成工具</p>
<p>Sysmon Box：Sysmon和网络捕获日志记录工具</p>
<div class="highlight"><pre><span></span>https://github.com/nshalabi/SysmonTools
</pre></div>
<h4>部署</h4>
<p>安装并且把Auto_Update.bat，自动更新加入定时任务,把相关的地址替换一下</p>
<div class="highlight"><pre><span></span>@echo off
setlocal
<span class="nb">set</span> <span class="nv">hour</span><span class="o">=</span>%time:~0,2%
<span class="nb">set</span> <span class="nv">minute</span><span class="o">=</span>%time:~3,2%
<span class="nb">set</span> /A <span class="nv">minute</span><span class="o">+=</span><span class="m">2</span>
<span class="k">if</span> %minute% GTR <span class="m">59</span> <span class="o">(</span>
 <span class="nb">set</span> /A minute-<span class="o">=</span><span class="m">60</span>
 <span class="nb">set</span> /A <span class="nv">hour</span><span class="o">+=</span><span class="m">1</span>
<span class="o">)</span>
<span class="k">if</span> %hour%<span class="o">==</span><span class="m">24</span> <span class="nb">set</span> <span class="nv">hour</span><span class="o">=</span><span class="m">00</span>
<span class="k">if</span> <span class="s2">"%hour:~0,1%"</span><span class="o">==</span><span class="s2">" "</span> <span class="nb">set</span> <span class="nv">hour</span><span class="o">=</span><span class="m">0</span>%hour:~1,1%
<span class="k">if</span> <span class="s2">"%hour:~1,1%"</span><span class="o">==</span><span class="s2">""</span> <span class="nb">set</span> <span class="nv">hour</span><span class="o">=</span><span class="m">0</span>%hour%
<span class="k">if</span> <span class="s2">"%minute:~1,1%"</span><span class="o">==</span><span class="s2">""</span> <span class="nb">set</span> <span class="nv">minute</span><span class="o">=</span><span class="m">0</span>%minute%
<span class="nb">set</span> <span class="nv">tasktime</span><span class="o">=</span>%hour%:%minute%
mkdir C:<span class="se">\w</span>indows<span class="se">\s</span>ysmon
<span class="nb">pushd</span> <span class="s2">"C:\windows\sysmon\"</span>
<span class="s2">echo [+] Downloading Sysmon...</span>
<span class="s2">@powershell (new-object System.Net.WebClient).DownloadFile('https://gitee.com/njcx86/sysmon-config/raw/master/Sysmon64.exe','C:\windows\sysmon\sysmon64.exe')"</span>
<span class="nb">echo</span> <span class="o">[</span>+<span class="o">]</span> Downloading Sysmon config...
@powershell <span class="o">(</span>new-object System.Net.WebClient<span class="o">)</span>.DownloadFile<span class="o">(</span><span class="s1">'https://gitee.com/njcx86/sysmon-config/raw/master/sysmonconfig-export.xml'</span>,<span class="s1">'C:\windows\sysmon\sysmonconfig-export.xml'</span><span class="o">)</span><span class="s2">"</span>
<span class="s2">@powershell (new-object System.Net.WebClient).DownloadFile('https://gitee.com/njcx86/sysmon-config/raw/master/Auto_Update.bat','C:\windows\sysmon\Auto_Update.bat')"</span>
sysmon64.exe -accepteula -i sysmonconfig-export.xml
sc failure Sysmon64 <span class="nv">actions</span><span class="o">=</span> restart/10000/restart/10000// <span class="nv">reset</span><span class="o">=</span> <span class="m">120</span>
<span class="nb">echo</span> <span class="o">[</span>+<span class="o">]</span> Sysmon Successfully Installed!
<span class="nb">echo</span> <span class="o">[</span>+<span class="o">]</span> Creating Auto Update Task <span class="nb">set</span> to Hourly..
SchTasks /Create /RU SYSTEM /RL HIGHEST /SC HOURLY /TN Update_Sysmon_Rules /TR C:<span class="se">\P</span>rogramData<span class="se">\s</span>ysmon<span class="se">\A</span>uto_Update.bat /F /ST %tasktime%
timeout /t <span class="m">10</span>
<span class="nb">exit</span>
</pre></div>
<p>Auto_Update.bat</p>
<div class="highlight"><pre><span></span>@echo on
<span class="nb">cd</span> C:<span class="se">\P</span>rogramData<span class="se">\s</span>ysmon<span class="se">\</span>
@powershell <span class="o">(</span>new-object System.Net.WebClient<span class="o">)</span>.DownloadFile<span class="o">(</span><span class="s1">'https://gitee.com/njcx86/sysmon-config/raw/master/sysmonconfig-export.xml'</span>,<span class="s1">'C:\windows\sysmon\sysmonconfig-export.xml'</span><span class="o">)</span><span class="s2">"</span>
<span class="s2">sysmon64 -c sysmonconfig-export.xml</span>
<span class="s2">exit</span>
</pre></div>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG3.jpeg"/></p>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG74.jpeg"/></p>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG74.jpeg"/></p>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG75.jpeg"/></p>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG76.jpeg"/></p>
<p>然后安装 Winlogbeat</p>
<div class="highlight"><pre><span></span>https://artifacts.elastic.co/downloads/beats/winlogbeat/winlogbeat-7.8.0-windows-x86_64.zip
</pre></div>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG78.jpeg"/>
<img alt="sysmon" class="img-fluid" src="../images/WechatIMG79.jpeg"/></p>
<p>output.kafka:
  # initial brokers for reading cluster metadata
  hosts: ["172.21.129.2:9092"]
  topic: 'win-hids'</p>
<div class="highlight"><pre><span></span>./kafka-console-consumer.sh --bootstrap-server <span class="m">172</span>.21.129.2:9092 --topic win-hids 
</pre></div>
<p><img alt="sysmon" class="img-fluid" src="../images/WechatIMG80.jpeg"/></p>
  </div>
</article>
<div id="cyReward" role="cylabs" data-use="reward" style="text-align:center;"></div>
<!--PC和WAP自适应版-->
<div id="SOHUCS" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cysYUIjwy'; 
var conf = 'prod_71b5e53cad0d27b5ed44fa5219b069b5'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

<script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cysYUIjwy"></script>    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="https://www.njcx.bid/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          本站由 <a href="https://github.com/getpelican/pelican" target="_blank">Pelican 生成</a> 后续 by <a href="https://github.com/njcx" target="_blank">nJcx</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>