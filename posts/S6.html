<!DOCTYPE html>
<html lang="zh">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="GgupatpoZgdqsBlxEZoMqGAy3aXAFtXIrYged3SB6EA" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Linux HIDS开发之eBPF应用 | nJcx's Blog
</title>
  <link rel="canonical" href="https://www.njcx.bid/posts/S6.html">


  <link rel="apple-touch-icon" href="https://www.njcx.bid/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://www.njcx.bid/manifest.json">
  <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/pygments/emacs.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/style.css">


<meta name="description" content="Linux HIDS开发之eBPF应用 ~">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a34c7a96ae9745547c373575407c521f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-4">
          <a href="https://www.njcx.bid">
            <img class="img-fluid" src=https://www.njcx.bid/images/profile.png width=200 height=200 alt="nJcx's Blog">
          </a>
        </div>
        <div class="col-sm-8">
          <h1 class="title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.njcx.bid">nJcx's Blog</a></h1>
          <p class="text-muted">十年生死两茫茫，写程序，到天亮。相顾无言，惟有泪千行</p>
          <ul class="list-inline">
                    <li class="list-inline-item">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.zhihu.com/people/njcxs" target="_blank">知乎</a></li>
                <li class="list-inline-item"><a href="https://www.anquanke.com/member/154147" target="_blank">安全客</a></li>
                <li class="list-inline-item"><a href="https://www.freebuf.com/column/1481" target="_blank">Freebuf</a></li>
            <li class=" list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/njcx" target="_blank"></a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>Linux HIDS开发之eBPF应用
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-08-21T20:20:00+03:00">
        <i class="fa fa-clock-o"></i>
        Tue 21 August 2018
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://www.njcx.bid/category/an-quan.html">安全</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://www.njcx.bid/author/njcx.html">nJcx</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://www.njcx.bid/tag/hids.html">#HIDS</a>      </li>
    </ul>
  </header>
  <div class="content">
    <h4>介绍</h4>
<p>BPF（Berkeley Packet Filter ），中文翻译为伯克利包过滤器，是类 Unix 系统上数据链路层的一种原始接口，提供原始链路层封包的收发。1992 年，Steven McCanne 和 Van Jacobson 写了一篇名为《BSD数据包过滤：一种新的用户级包捕获架构》的论文。在文中，作者描述了他们如何在 Unix 内核实现网络数据包过滤，这种新的技术比当时最先进的数据包过滤技术快 20 倍。BPF 在数据包过滤上引入了两大革新：</p>
<p>一个新的虚拟机 (VM) 设计，可以有效地工作在基于寄存器结构的 CPU 之上；</p>
<div class="highlight"><pre><span></span>应用程序使用缓存只复制与过滤数据包相关的数据，不会复制数据包的所有信息。这样可以最大程度地减少BPF 处理的数据；
</pre></div>
<p>由于这些巨大的改进，所有的 Unix 系统都选择采用 BPF 作为网络数据包过滤技术，直到今天，许多 Unix 内核的派生系统中（包括 Linux 内核）仍使用该实现。</p>
<p>2014 年初，Alexei Starovoitov 实现了 eBPF（extended Berkeley Packet Filter）。经过重新设计，eBPF 演进为一个通用执行引擎，可基于此开发性能分析工具、软件定义网络等诸多场景。eBPF 最早出现在 3.18 内核中，此后原来的 BPF 就被称为经典 BPF，缩写 cBPF（classic BPF），cBPF 现在已经基本废弃。现在，Linux 内核只运行 eBPF，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。</p>
<p>eBPF 新的设计针对现代硬件进行了优化，所以 eBPF 生成的指令集比旧的 BPF 解释器生成的机器码执行得更快。扩展版本也增加了虚拟机中的寄存器数量，将原有的 2 个 32 位寄存器增加到 10 个 64 位寄存器。由于寄存器数量和宽度的增加，开发人员可以使用函数参数自由交换更多的信息，编写更复杂的程序。总之，这些改进使 eBPF 版本的速度比原来的 BPF 提高了 4 倍。</p>
<p>eBPF 在 Linux 3.18 版本以后引入，并不代表只能在内核 3.18+ 版本上运行，低版本的内核升级到最新也可以使用 eBPF 能力，只是可能部分功能受限，比如我测试在CentOS7 3.10.940 以上都可以受限使用部分eBPF功能，低版本CentOS7 可以yum升级内核，重启支持部分eBPF 功能。</p>
<div class="highlight"><pre><span></span><span class="c1"># yum install kernel kernel-devel kernel-headers -y  </span>
<span class="c1"># reboot</span>
</pre></div>
<p><img alt="agent" class="img-fluid" src="../images/WechatIMG69.jpeg"/></p>
<p>eBPF 分为用户空间程序和内核程序两部分：</p>
<p>用户空间程序负责加载 BPF 字节码至内核，如需要也会负责读取内核回传的统计信息或者事件详情；
内核中的 BPF 字节码负责在内核中执行特定事件，如需要也会将执行的结果通过 maps 或者 perf-event 事件发送至用户空间；
其中用户空间程序与内核 BPF 字节码程序可以使用 map 结构实现双向通信，这为内核中运行的 BPF 字节码程序提供了更加灵活的控制。</p>
<p>用户空间程序与内核中的 BPF 字节码交互的流程主要如下：</p>
<p>我们可以使用 LLVM工具将编写的 BPF 代码程序编译成 BPF 字节码；
然后使用加载程序 Loader 将字节码加载至内核；内核使用验证器（verfier） 组件保证执行字节码的安全性，以避免内核panic，在确认字节码安全后将其加载对应的内核模块执行；BPF 观测技术相关的程序程序类型可能是 kprobes/uprobes/tracepoint/perf_events 中的一个或多个，其中：</p>
<div class="highlight"><pre><span></span>kprobes：实现内核中动态跟踪。 kprobes 可以跟踪到 Linux 内核中的导出函数入口或返回点，但是不是稳定 ABI 接口，可能会因为内核版本变化导致，导致跟踪失效。
uprobes：用户级别的动态跟踪。与 kprobes 类似，只是跟踪用户程序中的函数。
tracepoints：内核中静态跟踪。tracepoints 是内核开发人员维护的跟踪点，能够提供稳定的 ABI 接口，但是由于是研发人员维护，数量和场景可能受限。
perf_events：定时采样和 PMC。
内核中运行的 BPF 字节码程序可以使用两种方式将测量数据回传至用户空间
maps 方式可用于将内核中实现的统计摘要信息（比如测量延迟、堆栈信息）等回传至用户空间；
perf-event 用于将内核采集的事件实时发送至用户空间，用户空间程序实时读取分析；
</pre></div>
<p>eBPF 技术虽然强大，但是为了保证内核的处理安全和及时响应，内核中的 eBPF 技术也给予了诸多限制，当然随着技术的发展和演进，限制也在逐步放宽或者提供了对应的解决方案。</p>
<div class="highlight"><pre><span></span>eBPF 程序不能调用任意的内核参数，只限于内核模块中列出的 BPF Helper 函数，函数支持列表也随着内核的演进在不断增加。
eBPF 程序不允许包含无法到达的指令，防止加载无效代码，延迟程序的终止。
eBPF 程序中循环次数限制且必须在有限时间内结束，这主要是用来防止在 kprobes 中插入任意的循环，导致锁住整个系统；解决办法包括展开循环，并为需要循环的常见用途添加辅助函数。Linux 5.3 在 BPF 中包含了对有界循环的支持，它有一个可验证的运行时间上限。
eBPF 堆栈大小被限制在 MAX_BPF_STACK，截止到内核 Linux 5.8 版本，被设置为 512；参见 include/linux/filter.h，这个限制特别是在栈上存储多个字符串缓冲区时：一个char[256]缓冲区会消耗这个栈的一半。目前没有计划增加这个限制，解决方法是改用 bpf 映射存储，它实际上是无限的。
eBPF 字节码大小最初被限制为 4096 条指令，截止到内核 Linux 5.8 版本， 当前已将放宽至 100 万指令（ BPF_COMPLEXITY_LIMIT_INSNS），参见：include/linux/bpf.h，对于无权限的BPF程序，仍然保留 4096 条限制 ( BPF_MAXINSNS )；新版本的 eBPF 也支持了多个 eBPF 程序级联调用，虽然传递信息存在某些限制，但是可以通过组合实现更加强大的功能。
</pre></div>
<p><img alt="agent" class="img-fluid" src="../images/WechatIMG68.jpeg"/></p>
<p>eBPF支持的内核探针（Kernel probes）功能，允许开发者在几乎所有的内核指令中以最小的开销设置动态的标记或中断。当内核运行到某个标记的时候，就会执行附加到这个探测点上的代码，然后恢复正常的流程。对内核行为的追踪探测，可以获取内核中发生任何事件的信息，比如系统中打开的文件、正在执行的二进制文件、系统中发生的TCP连接等。</p>
<p>内核动态探针可以分为两种：kprobes 和 kretprobes。二者的区别在于，根据探针执行周期的不同阶段，来确定插入eBPF程序的位置。kprobes类型的探针用于跟踪内核函数调用，是一种功能强大的探针类型，让我们可以追踪成千上万的内核函数。由于它们用来跟踪底层内核的，开发者需要熟悉内核源代码，理解这些探针的参数、返回值的意义。</p>
<p>Kprobes通常在内核函数执行前插入eBPF程序，而kretprobes则在内核函数执行完毕返回之后，插入相应的eBPF程序。比如，tcp_connect() 是一个内核函数，当有TCP连接发生时，将调用该函数，那么如果对tcp_connect()使用kprobes探针，则对应的eBPF程序会在tcp_connect() 被调用时执行，而如果是使用kretprobes探针，则eBPF程序会在tcp_connect() 执行返回时执行。后文会举例说明如何使用Kprobes探针。</p>
<p>尽管Kprobes允许在执行任何内核功能之前插入eBPF程序。但是，它是一种“不稳定”的探针类型，开发者在使用Kprobes时，需要知道想要追踪的函数签名（Function Signature）。而Kprobes当前没有稳定的应用程序二进制接口（ABI），这意味着它们可能在内核不同的版本之间发生变化。如果内核版本不同，内核函数名、参数、返回值等可能会变化。如果尝试将相同的探针附加到具有两个不同内核版本的系统上，则相同的代码可能会停止工作。</p>
<p>因此，开发者需要确保使用Kprobe的eBPF程序与正在使用的特定内核版本是兼容的。</p>
<p>Tracepoints是在内核代码中所做的一种静态标记，是开发者在内核源代码中散落的一些hook，开发者可以依托这些hook实现相应的追踪代码插入。</p>
<p>开发者在/sys/kernel/debug/tracing/events/目录下，可以查看当前版本的内核支持的所有Tracepoints，在每一个具体Tracepoint目录下，都会有一系列对其进行配置说明的文件，比如可以通过enable中的值，来设置该Tracepoint探针的开关等。与Kprobes相比，他们的主要区别在于，Tracepoints是内核开发人员已经在内核代码中提前埋好的，这也是为什么称它们为静态探针的原因。而kprobes更多的是跟踪内核函数的进入和返回，因此将其称为动态的探针。但是内核函数会随着内核的发展而出现或者消失，因此kprobes对内核版本有着相对较强的依赖性，前文也有提到，针对某个内核版本实现的追踪代码，对于其它版本的内核，很有可能就不工作了。</p>
<p>那么，相比Kprobes探针，我们更加喜欢用Tracepoints探针，因为Tracepoints有着更稳定的应用程序编程接口，而且在内核中保持着前向兼容，总是保证旧版本中的跟踪点将存在于新版本中。</p>
<p>然而，Tracepoints的不足之处在于，这些探针需要开发人员将它们添加到内核中，因此，它们可能不会覆盖内核的所有子系统，只能使用当前版本内核所支持的探测点。</p>
<p>eBPF程序的主要数据结构是eBPF map，一种key-value数据结构。Maps通过bpf()系统调用创建和操作。</p>
<p>有不同类型的Map：</p>
<div class="highlight"><pre><span></span>BPF_MAP_TYPE_HASH：哈希表
BPF_MAP_TYPE_ARRAY：数组映射，已针对快速查找速度进行了优化，通常用于计数器
BPF_MAP_TYPE_PROG_ARRAY：对应eBPF程序的文件描述符数组；用于实现跳转表和子程序以处理特定的数据包协议
BPF_MAP_TYPE_PERCPU_ARRAY：每个CPU的阵列，用于实现延迟的直方图
BPF_MAP_TYPE_PERF_EVENT_ARRAY：存储指向struct perf_event的指针，用于读取和存储perf事件计数器
BPF_MAP_TYPE_CGROUP_ARRAY：存储指向控制组的指针
BPF_MAP_TYPE_PERCPU_HASH：每个CPU的哈希表
BPF_MAP_TYPE_LRU_HASH：仅保留最近使用项目的哈希表
BPF_MAP_TYPE_LRU_PERCPU_HASH：每个CPU的哈希表，仅保留最近使用的项目
BPF_MAP_TYPE_LPM_TRIE：最长前缀匹配树，适用于将IP地址匹配到某个范围
BPF_MAP_TYPE_STACK_TRACE：存储堆栈跟踪
BPF_MAP_TYPE_ARRAY_OF_MAPS：地图中地图数据结构
BPF_MAP_TYPE_HASH_OF_MAPS：地图中地图数据结构
BPF_MAP_TYPE_DEVICE_MAP：用于存储和查找网络设备引用
BPF_MAP_TYPE_SOCKET_MAP：存储和查找套接字，并允许使用BPF辅助函数进行套接字重定向
</pre></div>
<p>可以使用bpf_map_lookup_elem（）和 bpf_map_update_elem（）函数从eBPF或用户空间程序访问所有Map.</p>
<p>使用 man bpf 查看 bpf 系统调用，int bpf(int cmd, union bpf_attr *attr, unsigned int size)</p>
<p>第一个参数cmd，如下</p>
<div class="highlight"><pre><span></span>BPF_MAP_CREATE： 创建一个 map，并返回一个 fd，指向这个 map，这个 map 在 bpf 是非常重要的数据结构，用于 bpf 程序在内核态和用户态之间相互通信。
BPF_MAP_LOOKUP_ELEM： 在给定一个 map 中查询一个元素，并返回其值
BPF_MAP_UPDATE_ELEM： 在给定的 map 中创建或更新一个元素<span class="o">(</span>关于 key/value 的键值对<span class="o">)</span>
BPF_MAP_DELETE_ELEM： 在给定的 map 中删除一个元素<span class="o">(</span>关于 key/value 的键值对<span class="o">)</span>
BPF_MAP_GET_NEXT_KEY： 在一个特定的 map 中根据 key 值查找到一个元素，并返回这个 key 对应的下一个元素
BPF_PROG_LOAD： 验证并加载一个 bpf 程序。并返回与这个程序关联的 fd。

...... 等等
</pre></div>
<p>bpf_attr,第 2 个参数,该参数的类型取决于 cmd 参数的值，本文只分析 cmd=BPF_PROG_LOAD 这种情况，其中 prog_type 指定了 bpf 程序类型，eBPF 程序支持 attach 到不同的 event 上，比如 Kprobe，UProbe，tracepoint，Network packets，perf event 等。
完整如下：</p>
<div class="highlight"><pre><span></span>内核支持的当前eBPF程序类型集为：
BPF_PROG_TYPE_SOCKET_FILTER：网络数据包过滤器
BPF_PROG_TYPE_KPROBE：确定是否应触发kprobe
BPF_PROG_TYPE_SCHED_CLS：网络流量控制分类器
BPF_PROG_TYPE_SCHED_ACT：网络流量控制操作
BPF_PROG_TYPE_TRACEPOINT：确定是否应触发跟踪点
BPF_PROG_TYPE_XDP：从设备驱动程序接收路径运行的网络数据包过滤器
BPF_PROG_TYPE_PERF_EVENT：确定是否触发perf事件处理程序
BPF_PROG_TYPE_CGROUP_SKB：用于cgroups的网络数据包过滤器
BPF_PROG_TYPE_CGROUP_SOCK：用于cgroups的网络数据包过滤器，允许修改socket选项
BPF_PROG_TYPE_LWT_ *：用于隧道的网络数据包过滤器
BPF_PROG_TYPE_SOCK_OPS：用于设置socket参数的程序
BPF_PROG_TYPE_SK_SKB：网络数据包过滤器，用于在socket之间转发数据包
BPF_PROG_CGROUP_DEVICE：确定是否允许设备<span class="o">(</span>device<span class="o">)</span>操作
</pre></div>
<p>比如,cmd=BPF_PROG_LOAD 使用，bpf_attr 字段如下：</p>
<div class="highlight"><pre><span></span>struct <span class="o">{</span>    /* Used by BPF_PROG_LOAD */
    __u32   prog_type<span class="p">;</span>  //设置为 <span class="sb">`</span>BPF_PROG_TYPE_KPROBE<span class="sb">`</span>，表示是通过 kprobe 注入到内核函数。
    __u32   insn_cnt<span class="p">;</span>
    __aligned_u64 insns<span class="p">;</span>      /* <span class="s1">'const struct bpf_insn *'</span> */
    __aligned_u64 license<span class="p">;</span>    // 指定 license
    __u32   log_level<span class="p">;</span>  /* verbosity level of verifier */
    __u32   log_size<span class="p">;</span>   /* size of user buffer */
    __aligned_u64 log_buf<span class="p">;</span>    // 用户buff

    __u32   kern_version<span class="p">;</span>
    /* checked when <span class="nv">prog_type</span><span class="o">=</span>kprobe
    <span class="o">(</span>since Linux <span class="m">4</span>.1<span class="o">)</span> */
<span class="o">}</span><span class="p">;</span>
</pre></div>
<p>size：第三个参数</p>
<p>表示上述 bpf_attr 字节大小。</p>
<p>当加载 bpf 程序时，BPF_PROG_LOAD 表示的是加载具体 bpf 指令，对应 SEC宏 下面的函数代码段。
每条指令的操作码由5部分组成：</p>
<div class="highlight"><pre><span></span>    <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="p">{</span>
            <span class="n">__u8</span>    <span class="n">code</span><span class="p">;</span>           <span class="cm">/* opcode(操作码) */</span>
            <span class="n">__u8</span>    <span class="nl">dst_reg</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>      <span class="cm">/* dest register(目标寄存器) */</span>
            <span class="n">__u8</span>    <span class="nl">src_reg</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>      <span class="cm">/* source register (源寄存器)*/</span>
            <span class="n">__s16</span>   <span class="n">off</span><span class="p">;</span>            <span class="cm">/* signed offset(偏移)*/</span>
            <span class="n">__s32</span>   <span class="n">imm</span><span class="p">;</span>            <span class="cm">/* signed immediate constant(立即数) */</span>
    <span class="p">};</span>
</pre></div>
<p>详见</p>
<div class="highlight"><pre><span></span><span class="nv">insns</span><span class="o">=[</span>
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_LDX<span class="p">|</span>BPF_DW<span class="p">|</span>BPF_MEM, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_1, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_1, <span class="nv">off</span><span class="o">=</span><span class="m">104</span>, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_STX<span class="p">|</span>BPF_DW<span class="p">|</span>BPF_MEM, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_10, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_1, <span class="nv">off</span><span class="o">=</span>-8, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_ALU64<span class="p">|</span>BPF_X<span class="p">|</span>BPF_MOV, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_2, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_10, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_ALU64<span class="p">|</span>BPF_K<span class="p">|</span>BPF_ADD, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_2, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span>0xfffffff8<span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_LD<span class="p">|</span>BPF_DW<span class="p">|</span>BPF_IMM, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_1, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_1, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span>0x4<span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_LD<span class="p">|</span>BPF_W<span class="p">|</span>BPF_IMM, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_JMP<span class="p">|</span>BPF_K<span class="p">|</span>BPF_CALL, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span>0x3<span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_ALU64<span class="p">|</span>BPF_K<span class="p">|</span>BPF_MOV, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>,
<span class="o">{</span><span class="nv">code</span><span class="o">=</span>BPF_JMP<span class="p">|</span>BPF_K<span class="p">|</span>BPF_EXIT, <span class="nv">dst_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">src_reg</span><span class="o">=</span>BPF_REG_0, <span class="nv">off</span><span class="o">=</span><span class="m">0</span>, <span class="nv">imm</span><span class="o">=</span><span class="m">0</span><span class="o">}</span>
</pre></div>
<p>bpf系统调用调用bpf_prog_load来加载ebpf程序。
 bpf_prog_load大致有以下几步:</p>
<div class="highlight"><pre><span></span>1.调用bpf_prog_alloc为prog申请内存，大小为struct bpf_prog大小+ebpf指令总长度
2.将ebpf指令复制到prog-&gt;insns
3.调用bpf_check对ebpf程序合法性进行检查，这是ebpf的安全性的关键所在，不符ebpf规则的load失败
4.调用bpf_prog_select_runtime在线jit，编译ebpf指令成x64指令
5.调用bpf_prog_alloc_id为prog生成id，作为prog的唯一标识的id被很多工具如bpftool用来查找prog
</pre></div>
<p>ebpf从bpf的两个32位寄存器扩展到10个64位寄存器R0~R9和一个只读栈帧寄存器，并支持call指令，更加贴近现代64位处理器硬件</p>
<div class="highlight"><pre><span></span>R0对应rax， 函数返回值
R1对应rdi， 函数参数1
R2对应rsi， 函数参数2
R3对应rdx， 函数参数3
R4对应rcx， 函数参数4
R5对应r8， 函数参数5
R6对应rbx， callee保存
R7对应r13， callee保存
R8对应r14， callee保存
R9对应r15， callee保存
R10对应rbp，只读栈帧寄存器
</pre></div>
<p>可以看到x64的r9寄存器没有ebpf寄存器对应，所以ebpf函数最多支持5个参数。</p>
<p>demo 是在Kali Linux 上开发的。环境搭建比较简单，由于内核不一样，可能修改部分参数：</p>
<div class="highlight"><pre><span></span>apt-get install golang clang llvm  -y
</pre></div>
<p>CentOS 7 可以按下面搭建</p>
<div class="highlight"><pre><span></span>添加yum源 ： c7-clang-x86_64.repo

<span class="o">[</span>c7-devtoolset-8<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>c7-devtoolset-8
<span class="nv">baseurl</span><span class="o">=</span>https://buildlogs.centos.org/c7-devtoolset-8.x86_64/
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="o">[</span>c7-llvm-toolset-9<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>c7-llvm-toolset-9
<span class="nv">baseurl</span><span class="o">=</span>https://buildlogs.centos.org/c7-llvm-toolset-9.0.x86_64/
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>



<span class="c1"># yum install llvm-toolset-9.0  -y</span>
<span class="c1"># yum install kernel kernel-devel kernel-headers -y  </span>


环境变量如下：

<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/rh/llvm-toolset-9.0/root/bin
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/opt/rh/devtoolset-8/root/bin


在 /etc/ld.so.conf 添加如下内容，并 ldconfig：
/opt/rh/llvm-toolset-9.0/root/lib64


<span class="c1"># reboot 重启一下，应用新的内核</span>
</pre></div>
<p>HIDS 开发的核心在于抓取一些高风险 syscall的参数，比如，sys_ptrace() sys_execve(),这些函数被glibc 包装，暴露给用户使用。当用户在glibc调用对应的函数，通过执行CPU指令完成用户态向内核态的转换。32位系统中，通过int $0x80指令触发系统调用。其中EAX寄存器用于传递系统调用号，参数按顺序赋值给EBX、ECX、EDX、ESI、EDI、EBP这6个寄存器。64位系统则是使用syscall指令来触发系统调用，同样使用EAX寄存器传递系统调用号，RDI、RSI、RDX、RCX、R8、R9这6个寄存器则用来传递参数。系统调用逻辑，如下图：</p>
<p><img alt="agent" class="img-fluid" src="../images/WechatIMG145.jpeg"/></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kconfig.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/ptrace.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uapi/linux/ptrace.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">"bpf_helpers.h"</span><span class="cp"></span>

<span class="cp">#define ARG_LEN 256</span>

<span class="k">struct</span> <span class="n">execve_data_t</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">ktime_ns</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">real_start_time_ns</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">uid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">gid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">ppid</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">comm</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">execve_arg_t</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">_pad</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">arg</span><span class="p">[</span><span class="n">ARG_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">execve_rtn_t</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">rtn_code</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">exit_data_t</span> <span class="p">{</span>
    <span class="n">u64</span> <span class="n">ktime_ns</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">_pad</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bpf_map_def</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">"maps/execve_events"</span><span class="p">)</span> <span class="n">execve_events</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_PERF_EVENT_ARRAY</span><span class="p">,</span>
        <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
        <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">),</span>
        <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">copy_arg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">argp</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">src</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bpf_probe_read</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">ARG_LEN</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">send_arg</span><span class="p">(</span>
    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">execve_arg_t</span> <span class="o">*</span><span class="n">arg_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">arg_data</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">arg_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg_data</span><span class="p">));</span>
    <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">get_ppid</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">ppid</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">real_parent</span><span class="p">);</span>
    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ppid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ppid</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">u64</span> <span class="nf">get_process_start_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u64</span> <span class="n">real_start_time_ns</span><span class="p">;</span>
    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_start_time_ns</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">real_start_time_ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">real_start_time</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">real_start_time_ns</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"kprobe/SyS_execve"</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">kprobe__sys_exeve</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u64</span> <span class="n">ktime_ns</span> <span class="o">=</span> <span class="n">bpf_ktime_get_ns</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">bpf_get_current_task</span><span class="p">();</span> <span class="c1">// 4.8</span>
    <span class="n">u32</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">bpf_get_smp_processor_id</span><span class="p">();</span>

    <span class="c1">// Read general execve attributes.</span>
    <span class="k">struct</span> <span class="n">execve_data_t</span> <span class="n">execve_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">ktime_ns</span> <span class="o">=</span> <span class="n">ktime_ns</span><span class="p">,</span>
        <span class="p">.</span><span class="n">real_start_time_ns</span> <span class="o">=</span> <span class="n">get_process_start_time</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
        <span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
        <span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">bpf_get_current_uid_gid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="n">bpf_get_current_uid_gid</span><span class="p">(),</span>
        <span class="p">.</span><span class="n">ppid</span> <span class="o">=</span> <span class="n">get_ppid</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="n">bpf_get_current_comm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">execve_data</span><span class="p">.</span><span class="n">comm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">execve_data</span><span class="p">.</span><span class="n">comm</span><span class="p">));</span> <span class="c1">// 4.2</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">execve_data</span><span class="p">));</span>


    <span class="k">struct</span> <span class="n">execve_arg_t</span> <span class="n">arg_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">execve_data</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span>
    <span class="p">};</span>


    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="n">arg_data</span><span class="p">.</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg_data</span><span class="p">.</span><span class="n">arg</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PT_REGS_PARM1</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg_data</span><span class="p">));</span> <span class="c1">// 4.4</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="k">const</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PT_REGS_PARM2</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>


    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_arg</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_data</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>


    <span class="kt">char</span> <span class="n">ellipse</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"..."</span><span class="p">;</span>
    <span class="n">bpf_probe_read</span><span class="p">(</span><span class="n">arg_data</span><span class="p">.</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg_data</span><span class="p">.</span><span class="n">arg</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ellipse</span><span class="p">);</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg_data</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"kretprobe/SyS_execve"</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">kretprobe__sys_exeve</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">execve_rtn_t</span> <span class="n">rtn_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rtn_code</span> <span class="o">=</span> <span class="n">PT_REGS_RC</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="n">u32</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">bpf_get_smp_processor_id</span><span class="p">();</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtn_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rtn_data</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SEC</span><span class="p">(</span><span class="s">"kprobe/do_exit"</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">kprobe__do_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">exit_data_t</span> <span class="n">exit_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">ktime_ns</span> <span class="o">=</span> <span class="n">bpf_ktime_get_ns</span><span class="p">(),</span>
        <span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="n">u32</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">bpf_get_smp_processor_id</span><span class="p">();</span>
    <span class="n">bpf_perf_event_output</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">execve_events</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exit_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">exit_data</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="n">_license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">"license"</span><span class="p">)</span> <span class="o">=</span> <span class="s">"GPL"</span><span class="p">;</span>
</pre></div>
<p>bpf_helpers.h 文件</p>
<div class="highlight"><pre><span></span><span class="cp">#define SEC(NAME) __attribute__((section(NAME), used))</span>

<span class="cp">#define printt(fmt, ...)                                                   \</span>
<span class="cp">        ({                                                                 \</span>
<span class="cp">                char ____fmt[] = fmt;                                      \</span>
<span class="cp">                bpf_trace_printk(____fmt, sizeof(____fmt), ##__VA_ARGS__); \</span>
<span class="cp">        })</span>

<span class="cm">/* helper functions called from eBPF programs written in C */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">bpf_map_lookup_elem</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_map_lookup_elem</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_map_update_elem</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
                                  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_map_update_elem</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_map_delete_elem</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_map_delete_elem</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_probe_read</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unsafe_ptr</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_probe_read</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_ktime_get_ns</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_ktime_get_ns</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_trace_printk</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fmt_size</span><span class="p">,</span> <span class="p">...)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_trace_printk</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_get_smp_processor_id</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_smp_processor_id</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_get_current_pid_tgid</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_current_pid_tgid</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_get_current_uid_gid</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_current_uid_gid</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_get_current_comm</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_current_comm</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_perf_event_read</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_perf_event_read</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_clone_redirect</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_clone_redirect</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_redirect</span><span class="p">)(</span><span class="kt">int</span> <span class="n">ifindex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_redirect</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_perf_event_output</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span>
                                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
                                    <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_perf_event_output</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_skb_get_tunnel_key</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_skb_get_tunnel_key</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_skb_set_tunnel_key</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_skb_set_tunnel_key</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">long</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_get_prandom_u32</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_prandom_u32</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_current_task_under_cgroup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_current_task_under_cgroup</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">bpf_get_current_task</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_get_current_task</span><span class="p">;</span>

<span class="cm">/* llvm builtin functions that eBPF C program may use to</span>
<span class="cm"> * emit BPF_LD_ABS and BPF_LD_IND instructions</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">load_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span> <span class="k">asm</span><span class="p">(</span><span class="s">"llvm.bpf.load.byte"</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">load_half</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span> <span class="k">asm</span><span class="p">(</span><span class="s">"llvm.bpf.load.half"</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">load_word</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span> <span class="k">asm</span><span class="p">(</span><span class="s">"llvm.bpf.load.word"</span><span class="p">);</span>

<span class="cm">/* a helper structure used by eBPF C program</span>
<span class="cm"> * to describe map attributes to elf_bpf loader</span>
<span class="cm"> */</span>
<span class="cp">#define BUF_SIZE_MAP_NS 256</span>

<span class="k">struct</span> <span class="n">bpf_map_def</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_size</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value_size</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_entries</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map_flags</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pinning</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">namespace</span><span class="p">[</span><span class="n">BUF_SIZE_MAP_NS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_skb_store_bytes</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_skb_store_bytes</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_l3_csum_replace</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_l3_csum_replace</span><span class="p">;</span>
<span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bpf_l4_csum_replace</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">BPF_FUNC_l4_csum_replace</span><span class="p">;</span>

<span class="cp">#if defined(__x86_64__)</span>

<span class="cp">#define PT_REGS_PARM1(x) ((x)-&gt;di)</span>
<span class="cp">#define PT_REGS_PARM2(x) ((x)-&gt;si)</span>
<span class="cp">#define PT_REGS_PARM3(x) ((x)-&gt;dx)</span>
<span class="cp">#define PT_REGS_PARM4(x) ((x)-&gt;cx)</span>
<span class="cp">#define PT_REGS_PARM5(x) ((x)-&gt;r8)</span>
<span class="cp">#define PT_REGS_RET(x) ((x)-&gt;sp)</span>
<span class="cp">#define PT_REGS_FP(x) ((x)-&gt;bp)</span>
<span class="cp">#define PT_REGS_RC(x) ((x)-&gt;ax)</span>
<span class="cp">#define PT_REGS_SP(x) ((x)-&gt;sp)</span>
<span class="cp">#define PT_REGS_IP(x) ((x)-&gt;ip)</span>

<span class="cp">#elif defined(__s390x__)</span>

<span class="cp">#define PT_REGS_PARM1(x) ((x)-&gt;gprs[2])</span>
<span class="cp">#define PT_REGS_PARM2(x) ((x)-&gt;gprs[3])</span>
<span class="cp">#define PT_REGS_PARM3(x) ((x)-&gt;gprs[4])</span>
<span class="cp">#define PT_REGS_PARM4(x) ((x)-&gt;gprs[5])</span>
<span class="cp">#define PT_REGS_PARM5(x) ((x)-&gt;gprs[6])</span>
<span class="cp">#define PT_REGS_RET(x) ((x)-&gt;gprs[14])</span>
<span class="cp">#define PT_REGS_FP(x) ((x)-&gt;gprs[11]) </span><span class="cm">/* Works only with CONFIG_FRAME_POINTER */</span><span class="cp"></span>
<span class="cp">#define PT_REGS_RC(x) ((x)-&gt;gprs[2])</span>
<span class="cp">#define PT_REGS_SP(x) ((x)-&gt;gprs[15])</span>
<span class="cp">#define PT_REGS_IP(x) ((x)-&gt;ip)</span>

<span class="cp">#elif defined(__aarch64__)</span>

<span class="cp">#define PT_REGS_PARM1(x) ((x)-&gt;regs[0])</span>
<span class="cp">#define PT_REGS_PARM2(x) ((x)-&gt;regs[1])</span>
<span class="cp">#define PT_REGS_PARM3(x) ((x)-&gt;regs[2])</span>
<span class="cp">#define PT_REGS_PARM4(x) ((x)-&gt;regs[3])</span>
<span class="cp">#define PT_REGS_PARM5(x) ((x)-&gt;regs[4])</span>
<span class="cp">#define PT_REGS_RET(x) ((x)-&gt;regs[30])</span>
<span class="cp">#define PT_REGS_FP(x) ((x)-&gt;regs[29]) </span><span class="cm">/* Works only with CONFIG_FRAME_POINTER */</span><span class="cp"></span>
<span class="cp">#define PT_REGS_RC(x) ((x)-&gt;regs[0])</span>
<span class="cp">#define PT_REGS_SP(x) ((x)-&gt;sp)</span>
<span class="cp">#define PT_REGS_IP(x) ((x)-&gt;pc)</span>

<span class="cp">#elif defined(__powerpc__)</span>

<span class="cp">#define PT_REGS_PARM1(x) ((x)-&gt;gpr[3])</span>
<span class="cp">#define PT_REGS_PARM2(x) ((x)-&gt;gpr[4])</span>
<span class="cp">#define PT_REGS_PARM3(x) ((x)-&gt;gpr[5])</span>
<span class="cp">#define PT_REGS_PARM4(x) ((x)-&gt;gpr[6])</span>
<span class="cp">#define PT_REGS_PARM5(x) ((x)-&gt;gpr[7])</span>
<span class="cp">#define PT_REGS_RC(x) ((x)-&gt;gpr[3])</span>
<span class="cp">#define PT_REGS_SP(x) ((x)-&gt;sp)</span>
<span class="cp">#define PT_REGS_IP(x) ((x)-&gt;nip)</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef __powerpc__</span>
<span class="cp">#define BPF_KPROBE_READ_RET_IP(ip, ctx)         ({ (ip) = (ctx)-&gt;link; })</span>
<span class="cp">#define BPF_KRETPROBE_READ_RET_IP               BPF_KPROBE_READ_RET_IP</span>
<span class="cp">#else</span>
<span class="cp">#define BPF_KPROBE_READ_RET_IP(ip, ctx)         ({                              \</span>
<span class="cp">                bpf_probe_read(&amp;(ip), sizeof(ip), (void *)PT_REGS_RET(ctx)); })</span>
<span class="cp">#define BPF_KRETPROBE_READ_RET_IP(ip, ctx)      ({                              \</span>
<span class="cp">                bpf_probe_read(&amp;(ip), sizeof(ip),                               \</span>
<span class="cp">                                (void *)(PT_REGS_FP(ctx) + sizeof(ip))); })</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>
</pre></div>
<p>Makefile </p>
<div class="highlight"><pre><span></span><span class="n">project_root</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">pwd</span><span class="p">)</span>
<span class="n">uname</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">uname</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span>
<span class="n">kernel_src</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">qa</span> <span class="n">kernel</span><span class="o">-</span><span class="n">devel</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">sed</span> <span class="err">'</span><span class="n">s</span><span class="o">/</span><span class="n">kernel</span><span class="o">-</span><span class="n">devel</span><span class="o">-</span><span class="c1">//g' | awk '{print "/usr/src/kernels/"$$1""}')</span>

<span class="nl">all</span><span class="p">:</span> <span class="n">build</span>

<span class="nl">build</span><span class="p">:</span>
        <span class="n">clang</span> \
      <span class="o">-</span><span class="n">D__KERNEL__</span> \
      <span class="o">-</span><span class="n">D__ASM_SYSREG_H</span> \
      <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">packed</span><span class="o">-</span><span class="n">member</span> \
      <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">emit</span><span class="o">-</span><span class="n">llvm</span> <span class="o">-</span><span class="n">c</span> <span class="n">exec</span><span class="p">.</span><span class="n">c</span> \
      <span class="o">-</span><span class="n">I</span> <span class="err">$</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span> \
      <span class="o">-</span><span class="n">I</span> <span class="err">$</span><span class="p">(</span><span class="n">kernel_src</span><span class="p">)</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span> \
      <span class="o">-</span><span class="n">I</span> <span class="err">$</span><span class="p">(</span><span class="n">kernel_src</span><span class="p">)</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span> \
      <span class="o">-</span><span class="n">I</span> <span class="err">$</span><span class="p">(</span><span class="n">kernel_src</span><span class="p">)</span><span class="o">/</span><span class="n">include</span> \
      <span class="o">-</span><span class="n">o</span> <span class="o">-</span> <span class="o">|</span> \
      <span class="n">llc</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">bpf</span> <span class="o">-</span><span class="n">filetype</span><span class="o">=</span><span class="n">obj</span> <span class="o">-</span><span class="n">o</span> <span class="n">exec</span><span class="p">.</span><span class="n">o</span>

<span class="p">.</span><span class="nl">PHONY</span><span class="p">:</span> <span class="n">all</span> <span class="n">build</span> 
</pre></div>
<p>go接受数据：</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">"bytes"</span>
    <span class="s2">"encoding/binary"</span>
    <span class="s2">"encoding/json"</span>
    <span class="s2">"fmt"</span>
    <span class="n">bpf</span> <span class="s2">"github.com/iovisor/gobpf/elf"</span>
    <span class="s2">"github.com/pkg/errors"</span>
    <span class="s2">"io/ioutil"</span>
    <span class="s2">"os"</span>
    <span class="s2">"os/signal"</span>
    <span class="s2">"sync"</span>
    <span class="s2">"time"</span>
    <span class="s2">"unsafe"</span>
<span class="p">)</span>

<span class="n">var</span> <span class="p">(</span>
    <span class="n">sizeofExecveData</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Sizeof</span><span class="p">(</span><span class="n">ExecveData</span><span class="p">{}))</span>
    <span class="n">sizeofExecveArg</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Sizeof</span><span class="p">(</span><span class="n">ExecveArg</span><span class="p">{}))</span>
    <span class="n">sizeofExecveRtn</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Sizeof</span><span class="p">(</span><span class="n">ExecveRtn</span><span class="p">{}))</span>
    <span class="n">sizeofExitData</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unsafe</span><span class="o">.</span><span class="n">Sizeof</span><span class="p">(</span><span class="n">ExitData</span><span class="p">{}))</span>
<span class="p">)</span>
<span class="n">const</span> <span class="p">(</span>
    <span class="n">execveProbe</span>       <span class="o">=</span> <span class="s2">"kprobe/SyS_execve"</span>
    <span class="n">execveReturnProbe</span> <span class="o">=</span> <span class="s2">"kretprobe/SyS_execve"</span>
    <span class="n">execveMap</span>         <span class="o">=</span> <span class="s2">"execve_events"</span>
    <span class="n">doExitProbe</span>       <span class="o">=</span> <span class="s2">"kprobe/do_exit"</span>
<span class="p">)</span>


<span class="nb">type</span> <span class="n">ExecveData</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">KTimeNS</span>         <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="n">RealStartTimeNS</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span>
    <span class="n">PID</span>             <span class="n">uint32</span>
    <span class="n">UID</span>             <span class="n">uint32</span>
    <span class="n">GID</span>             <span class="n">uint32</span>
    <span class="n">PPID</span>            <span class="n">uint32</span>
    <span class="n">Comm</span>            <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="n">byte</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">ExecveArg</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">PID</span> <span class="n">uint32</span>
    <span class="n">_</span>   <span class="n">uint32</span>
    <span class="n">Arg</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="n">byte</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">ExecveRtn</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">PID</span>        <span class="n">uint32</span>
    <span class="n">ReturnCode</span> <span class="n">int32</span>
<span class="p">}</span>


<span class="nb">type</span> <span class="n">ExitData</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">KTime</span> <span class="n">uint64</span>
    <span class="n">PID</span>   <span class="n">uint32</span>
<span class="p">}</span>


<span class="nb">type</span> <span class="n">processData</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">StartTime</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="sb">`json:"start_time"`</span>

    <span class="n">PPID</span>       <span class="n">uint32</span> <span class="sb">`json:"ppid"`</span>
    <span class="n">ParentComm</span> <span class="n">string</span> <span class="sb">`json:"parent_comm,omitempty"`</span>

    <span class="n">PID</span>  <span class="n">uint32</span>   <span class="sb">`json:"pid"`</span>
    <span class="n">UID</span>  <span class="n">uint32</span>   <span class="sb">`json:"uid"`</span>
    <span class="n">GID</span>  <span class="n">uint32</span>   <span class="sb">`json:"gid"`</span>
    <span class="n">Comm</span> <span class="n">string</span>   <span class="sb">`json:"comm,omitempty"`</span>
    <span class="n">Exe</span>  <span class="n">string</span>   <span class="sb">`json:"exe,omitempty"`</span>
    <span class="n">Args</span> <span class="p">[]</span><span class="n">string</span> <span class="sb">`json:"args,omitempty"`</span>
<span class="p">}</span>


<span class="nb">type</span> <span class="n">ProcessStarted</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">Type</span> <span class="n">string</span> <span class="sb">`json:"type"`</span>
    <span class="n">processData</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">ProcessExited</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">Type</span> <span class="n">string</span> <span class="sb">`json:"type"`</span>
    <span class="n">processData</span>
    <span class="n">EndTime</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span>     <span class="sb">`json:"end_time"`</span>
    <span class="n">RunningTime</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span> <span class="sb">`json:"running_time_ns"`</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">ProcessError</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">Type</span> <span class="n">string</span> <span class="sb">`json:"type"`</span>
    <span class="n">processData</span>
    <span class="n">ErrorCode</span> <span class="n">int32</span> <span class="sb">`json:"error_code"`</span>
<span class="p">}</span>


<span class="nb">type</span> <span class="n">ProcessMonitor</span> <span class="n">struct</span> <span class="p">{</span>

    <span class="n">module</span>        <span class="o">*</span><span class="n">bpf</span><span class="o">.</span><span class="n">Module</span>
    <span class="n">execvePerfMap</span> <span class="o">*</span><span class="n">bpf</span><span class="o">.</span><span class="n">PerfMap</span>
    <span class="n">bpfEvents</span>     <span class="n">chan</span> <span class="p">[]</span><span class="n">byte</span>
    <span class="n">lostBPFEvents</span> <span class="n">chan</span> <span class="n">uint64</span>
    <span class="n">lostCount</span>     <span class="n">uint64</span>

    <span class="n">bootTime</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
    <span class="n">processTable</span> <span class="nb">map</span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="o">*</span><span class="n">process</span>
    <span class="n">warnOnce</span>     <span class="n">sync</span><span class="o">.</span><span class="n">Once</span>

    <span class="n">output</span> <span class="n">chan</span> <span class="n">interface</span><span class="p">{}</span>
    <span class="n">done</span>   <span class="o">&lt;-</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{}</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">eventSource</span> <span class="nb">int</span>

<span class="n">const</span> <span class="p">(</span>
    <span class="n">sourceBPF</span> <span class="n">eventSource</span> <span class="o">=</span> <span class="n">iota</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="nb">type</span> <span class="n">processState</span> <span class="nb">int</span>

<span class="n">const</span> <span class="p">(</span>
    <span class="n">stateStarted</span> <span class="n">processState</span> <span class="o">=</span> <span class="n">iota</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">stateError</span>
    <span class="n">stateExited</span>
<span class="p">)</span>

<span class="nb">type</span> <span class="n">process</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">processData</span>
    <span class="n">State</span>     <span class="n">processState</span>
    <span class="n">Source</span>    <span class="n">eventSource</span>
    <span class="n">EndTime</span>   <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
    <span class="n">ErrorCode</span> <span class="n">int32</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">NewMonitor</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="n">ProcessMonitor</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">ProcessMonitor</span><span class="p">{</span>
        <span class="n">processTable</span><span class="p">:</span> <span class="nb">map</span><span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="o">*</span><span class="n">process</span><span class="p">{},</span>
    <span class="p">},</span> <span class="n">nil</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">ProcessMonitor</span><span class="p">)</span> <span class="n">Start</span><span class="p">(</span><span class="n">done</span> <span class="o">&lt;-</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{})</span> <span class="p">(</span><span class="o">&lt;-</span><span class="n">chan</span> <span class="n">interface</span><span class="p">{},</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">initBPF</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="n">m</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">interface</span><span class="p">{},</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">defer</span> <span class="n">close</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="n">defer</span> <span class="n">m</span><span class="o">.</span><span class="n">execvePerfMap</span><span class="o">.</span><span class="n">PollStop</span><span class="p">()</span>
        <span class="n">defer</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">{</span>
            <span class="n">select</span> <span class="p">{</span>
            <span class="n">case</span> <span class="n">data</span> <span class="p">:</span><span class="o">=</span> <span class="o">&lt;-</span><span class="n">m</span><span class="o">.</span><span class="n">bpfEvents</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">handleBPFData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">case</span> <span class="n">count</span> <span class="p">:</span><span class="o">=</span> <span class="o">&lt;-</span><span class="n">m</span><span class="o">.</span><span class="n">lostBPFEvents</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">lostCount</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">"%v messages from kernel dropped"</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">case</span> <span class="o">&lt;-</span><span class="n">done</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">nil</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">ProcessMonitor</span><span class="p">)</span> <span class="n">initBPF</span><span class="p">()</span> <span class="n">error</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="s2">"exec.o"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrap</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to load embedded ebpf code"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Load</span> <span class="n">module</span> <span class="n">to</span> <span class="n">kernel</span><span class="o">.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">bpf</span><span class="o">.</span><span class="n">NewModuleFromReader</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="n">nil</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrap</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to load ebpf module to kernel"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Setup</span> <span class="n">our</span> <span class="n">perf</span> <span class="n">event</span> <span class="n">readers</span><span class="o">.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">bpfEvents</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="p">[]</span><span class="n">byte</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">lostBPFEvents</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">uint64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">execvePerfMap</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">bpf</span><span class="o">.</span><span class="n">InitPerfMap</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">execveMap</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bpfEvents</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">lostBPFEvents</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrapf</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to initialize %v perf map"</span><span class="p">,</span> <span class="n">execveMap</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Enable</span> <span class="n">the</span> <span class="n">kprobes</span><span class="o">.</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">EnableKprobe</span><span class="p">(</span><span class="n">execveProbe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrapf</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to enable %v probe"</span><span class="p">,</span> <span class="n">execveProbe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">EnableKprobe</span><span class="p">(</span><span class="n">execveReturnProbe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrapf</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to enable %v probe"</span><span class="p">,</span> <span class="n">execveReturnProbe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">EnableKprobe</span><span class="p">(</span><span class="n">doExitProbe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">m</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrapf</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">"failed to enable %v probe"</span><span class="p">,</span> <span class="n">doExitProbe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">m</span><span class="o">.</span><span class="n">execvePerfMap</span><span class="o">.</span><span class="n">PollStart</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">ProcessMonitor</span><span class="p">)</span> <span class="n">handleBPFData</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">switch</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">sizeofExecveData</span><span class="p">:</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">unmarshalData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to unmarshal execve data"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>


        <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">exists</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">];</span> <span class="n">exists</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">process</span><span class="p">{</span>
            <span class="n">State</span><span class="p">:</span>  <span class="n">stateStarted</span><span class="p">,</span>
            <span class="n">Source</span><span class="p">:</span> <span class="n">sourceBPF</span><span class="p">,</span>
            <span class="n">processData</span><span class="p">:</span> <span class="n">processData</span><span class="p">{</span>
                <span class="n">StartTime</span><span class="p">:</span>  <span class="n">m</span><span class="o">.</span><span class="n">bootTime</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">RealStartTimeNS</span><span class="p">),</span>
                <span class="n">PPID</span><span class="p">:</span>       <span class="n">event</span><span class="o">.</span><span class="n">PPID</span><span class="p">,</span>
                <span class="n">ParentComm</span><span class="p">:</span> <span class="n">NullTerminatedString</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">Comm</span><span class="p">[:]),</span>
                <span class="n">PID</span><span class="p">:</span>        <span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">,</span>
                <span class="n">UID</span><span class="p">:</span>        <span class="n">event</span><span class="o">.</span><span class="n">UID</span><span class="p">,</span>
                <span class="n">GID</span><span class="p">:</span>        <span class="n">event</span><span class="o">.</span><span class="n">GID</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="n">case</span> <span class="n">sizeofExecveArg</span><span class="p">:</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">unmarshalArg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to unmarshal execve arg"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">p</span><span class="p">,</span> <span class="n">found</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">]</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">found</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">The</span> <span class="n">first</span> <span class="n">argument</span> <span class="n">sent</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">exe</span><span class="o">.</span>
        <span class="n">arg</span> <span class="p">:</span><span class="o">=</span> <span class="n">NullTerminatedString</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">Arg</span><span class="p">[:])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Exe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">p</span><span class="o">.</span><span class="n">Exe</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">.</span><span class="n">Args</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Args</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="n">case</span> <span class="n">sizeofExecveRtn</span><span class="p">:</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">unmarshalRtn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to unmarshal execve return"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">p</span><span class="p">,</span> <span class="n">found</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">]</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">found</span>  <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ReturnCode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">p</span><span class="o">.</span><span class="n">State</span> <span class="o">=</span> <span class="n">stateError</span>
            <span class="n">p</span><span class="o">.</span><span class="n">ErrorCode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ReturnCode</span>
        <span class="p">}</span>

        <span class="n">m</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">case</span> <span class="n">sizeofExitData</span><span class="p">:</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">unmarshalExitData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
            <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to unmarshal exit data"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">p</span><span class="p">,</span> <span class="n">found</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">]</span>
        <span class="k">if</span> <span class="err">!</span><span class="n">found</span> <span class="o">||</span> <span class="n">p</span><span class="o">.</span><span class="n">ErrorCode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">.</span><span class="n">State</span> <span class="o">=</span> <span class="n">stateExited</span>
        <span class="n">p</span><span class="o">.</span><span class="n">EndTime</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">bootTime</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">KTime</span><span class="p">))</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">processTable</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">PID</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">ProcessMonitor</span><span class="p">)</span> <span class="n">publish</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">process</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">event</span> <span class="n">interface</span><span class="p">{}</span>
    <span class="n">switch</span> <span class="n">p</span><span class="o">.</span><span class="n">State</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">stateStarted</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">ProcessStarted</span><span class="p">{</span>
            <span class="n">Type</span><span class="p">:</span>        <span class="s2">"started"</span><span class="p">,</span>
            <span class="n">processData</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">processData</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">case</span> <span class="n">stateExited</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">ProcessExited</span><span class="p">{</span>
            <span class="n">Type</span><span class="p">:</span>        <span class="s2">"exited"</span><span class="p">,</span>
            <span class="n">processData</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">processData</span><span class="p">,</span>
            <span class="n">EndTime</span><span class="p">:</span>     <span class="n">p</span><span class="o">.</span><span class="n">EndTime</span><span class="p">,</span>
            <span class="n">RunningTime</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">EndTime</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">StartTime</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="n">case</span> <span class="n">stateError</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">ProcessError</span><span class="p">{</span>
            <span class="n">Type</span><span class="p">:</span>        <span class="s2">"error"</span><span class="p">,</span>
            <span class="n">processData</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">processData</span><span class="p">,</span>
            <span class="n">ErrorCode</span><span class="p">:</span>   <span class="n">p</span><span class="o">.</span><span class="n">ErrorCode</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">default</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="n">select</span> <span class="p">{</span>
    <span class="n">case</span> <span class="o">&lt;-</span><span class="n">m</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
    <span class="n">case</span> <span class="n">m</span><span class="o">.</span><span class="n">output</span> <span class="o">&lt;-</span> <span class="n">event</span><span class="p">:</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="n">func</span> <span class="n">unmarshalData</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">ExecveData</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">event</span> <span class="n">ExecveData</span>
    <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>


<span class="n">func</span> <span class="n">unmarshalArg</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">ExecveArg</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">event</span> <span class="n">ExecveArg</span>
    <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">unmarshalRtn</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">ExecveRtn</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">event</span> <span class="n">ExecveRtn</span>
    <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">unmarshalExitData</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">ExitData</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">var</span> <span class="n">event</span> <span class="n">ExitData</span>
    <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">binary</span><span class="o">.</span><span class="n">LittleEndian</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">NullTerminatedString</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
    <span class="n">nullTerm</span> <span class="p">:</span><span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">IndexByte</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nullTerm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">nullTerm</span><span class="p">])</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">NewMonitor</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to create exec monitor"</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">done</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">struct</span><span class="p">{})</span>
    <span class="n">events</span><span class="p">,</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"failed to start exec monitor"</span><span class="p">,</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">sig</span> <span class="p">:</span><span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Kill</span><span class="p">)</span>
    <span class="n">go</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="o">&lt;-</span><span class="n">sig</span>
        <span class="n">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="k">for</span> <span class="n">e</span> <span class="p">:</span><span class="o">=</span> <span class="nb">range</span> <span class="n">events</span> <span class="p">{</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="p">:</span><span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
  </div>
</article>
<div id="cyReward" role="cylabs" data-use="reward" style="text-align:center;"></div>
<!--PC和WAP自适应版-->
<div id="SOHUCS" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cysYUIjwy'; 
var conf = 'prod_71b5e53cad0d27b5ed44fa5219b069b5'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

<script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cysYUIjwy"></script>    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="https://www.njcx.bid/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          本站由 <a href="https://github.com/getpelican/pelican" target="_blank">Pelican 生成</a> 后续 by <a href="https://github.com/njcx" target="_blank">nJcx</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>