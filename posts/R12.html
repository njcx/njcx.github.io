<!DOCTYPE html>
<html lang="zh">

<head>
  <!-- Required meta tags always come first -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="GgupatpoZgdqsBlxEZoMqGAy3aXAFtXIrYged3SB6EA" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>HIDS-Agent开发之抓取DNS请求和异常分析 | nJcx's Blog
</title>
  <link rel="canonical" href="https://www.njcx.bid/posts/R12.html">


  <link rel="apple-touch-icon" href="https://www.njcx.bid/apple-touch-icon.png" sizes="180x180">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.njcx.bid/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://www.njcx.bid/manifest.json">
  <meta name="theme-color" content="#333333">

  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/pygments/emacs.min.css">
  <link rel="stylesheet" href="https://www.njcx.bid/theme/css/style.css">


<meta name="description" content="HIDS-Agent开发之抓取DNS请求和异常分析 ~">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a34c7a96ae9745547c373575407c521f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head>

<body>
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="col-sm-4">
          <a href="https://www.njcx.bid">
            <img class="img-fluid" src=https://www.njcx.bid/images/profile.png width=200 height=200 alt="nJcx's Blog">
          </a>
        </div>
        <div class="col-sm-8">
          <h1 class="title">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.njcx.bid">nJcx's Blog</a></h1>
          <p class="text-muted">十年生死两茫茫，写程序，到天亮。相顾无言，惟有泪千行</p>
          <ul class="list-inline">
                    <li class="list-inline-item">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<a href="https://www.zhihu.com/people/njcxs" target="_blank">知乎</a></li>
                <li class="list-inline-item"><a href="https://www.facebook.com/nJcx1" target="_blank">FaceBook</a></li>
                <li class="list-inline-item"><a href="https://github.com/njcx" target="_blank">Github</a></li>
            <li class=" list-inline-item text-muted">|</li>
            <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/njcx" target="_blank"></a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>HIDS-Agent开发之抓取DNS请求和异常分析
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-08-13T20:20:00+03:00">
        <i class="fa fa-clock-o"></i>
        Mon 13 August 2018
      </li>
      <li class="list-inline-item">
        <i class="fa fa-folder-open-o"></i>
        <a href="https://www.njcx.bid/category/an-quan.html">安全</a>
      </li>
      <li class="list-inline-item">
        <i class="fa fa-user-o"></i>
        <a href="https://www.njcx.bid/author/njcx.html">nJcx</a>      </li>
      <li class="list-inline-item">
        <i class="fa fa-files-o"></i>
        <a href="https://www.njcx.bid/tag/hids.html">#HIDS</a>      </li>
    </ul>
  </header>
  <div class="content">
    <h4>介绍</h4>
<p>使用 cgroups + etcd + kafka 开发而成的hids的架构，agent 部分使用go 开发而成， 会把采集的数据写入到kafka里面，由后端的规则引擎（go开发而成）消费，配置部分以及agent存活使用etcd。关于agent 使用cgroups限制资源以及使用etcd做配置管理agent存活已经在前文介绍了一下。下面介绍一下agent抓取DNS请求和异常分析的部分</p>
<p><img alt="agent" class="img-fluid" src="../images/dnsgenformat.png"/></p>
<p><img alt="agent" class="img-fluid" src="../images/dnsheaderformat.png"/></p>
<p><img alt="agent" class="img-fluid" src="../images/02-DNS-Message-Header-Flags-Codes.png"/></p>
<p><img alt="agent" class="img-fluid" src="../images/dnsquestionformat.png"/></p>
<p><img alt="agent" class="img-fluid" src="../images/dnsrrformat.png"/></p>
<p>DNS 报文格式
DNS 请求的格式和响应格式差不多，就不单独讲了。从 UDP 数据包的正文部分算起，DNS 报文的结构按顺序如下：</p>
<p>数据类型    Ethereal 里的名字   说明
uint16_t    Transaction ID  标识符。下文说明
uint16_t    Flags   参数。下文说明
uint16_t    Questions   询问列表的数目
uint16_t    Answer RRs  (直接) 的回答数
uint16_t    Authority RRs   认证机构数目（仅响应包里有）
uint16_t    Additional RRs  附加信息数目（仅响应包里有）
variable    Queries 请求数据的正文。请求包中只有这个。响应包也会附上原本的请求数据
variable    Answers 响应数据的正文
variable    Authortative name servers   域名管理机构数据
variable    Additional records  附加信息数据
Transaction ID：这是由 client 端指定的标识数据，DNS server 会将这个字段原样返回，client 端可以用来区分不同的 DNS 请求
RR：Resource Record 的缩写
Flags
16 bits 的值，各部分按顺序如下（按顺序：位号、Ethereal 名称、说明）：</p>
<p>Bit 15，Response：0 表示查询，1 表示响应（query / response）
Bit 14~11, Opcode：查询类型——请求和响应包都适用：</p>
<p>0：普通查询（最常用的）
1：反向查询
2：服务器状态请求
3：通知
4：更新（貌似是用在 DDNS 的？）
Bit 10, Authoritative：用于响应包，判断服务器是否一个认证的域服务器
Bit 9, Truncated：报文是否被截断了。收发包都用
Bit 8, Recursion desired：收发包都用，表示是否需要用递归。作为 client 端，最好置 1，要不然 DNS 不执行递归查询，将有很多数据没能查到
Bit 7, Recursion available：响应包用，表示服务器是否有能力使用递归查询
Bit 6：这个数据段，Ethereal 说是保留位，而书中表示数据是否是鉴别的——求确认
Bit 5, Answer authenticated：数据是否被服务器鉴定过（貌似抓到的包里都是 0）
Bit 4, Reserved
Bit 3~0, Reply code：响应状态码，如下（参见 Micrisoft 资料 的 “DNS update message flags field” 小节）：</p>
<p>0：OK
1：查询格式错误
2：服务器内部错误
3：名字不存在
4：这个错误码不支持
5：请求被拒绝
6：name 在不应当出现时出现（什么鬼）
7：RR 设置不存在
8：RR 设置应当存在但是却不存在（什么鬼）
9：服务器不具备改管理区的权限
10：name 不在管理区中
资源记录（RR）的格式
每一条 RR 的格式如下：</p>
<p>数据类型    Ethereal 里的名字   说明
variable    Name    资源的域名——其实前文已经出现了
uint16_t    Type    类型。下文说明
uint16_t    Class   大多数是 0x0001，代表 IN
uint32_t    Time to Live    TTL 秒数
uint16_t    Data length 当前 RR 剩余部分的长度
variable        RR 主数据
如果是请求数据的话，那么 TTL、Data Length 和 RR 主数据都不需要</p>
<p>Type 的大部分值在 RFC-1035 中定义，此外的一些在其他文档定义（比如 IPv6）。我会用到的有：</p>
<p>1：“A”，表示 IPv4 地址
2：“NS”，域名服务器的名字
28：“AAAA”，表示 IPv6 地址
5：“CNAME”，规范名，经常会有一个 CNAME 跟着一票 A 和 AAAA</p>
<h4></h4>
<h4></h4>
<h4></h4>
<h4></h4>
<h4></h4>
<p>实例代码</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">"fmt"</span>
    <span class="s">"log"</span>
    <span class="s">"errors"</span>
    <span class="s">"github.com/google/gopacket"</span>
    <span class="s">"github.com/google/gopacket/layers"</span>
    <span class="s">"github.com/google/gopacket/pcap"</span>

<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">SrcIP</span>      <span class="kt">string</span>
    <span class="nx">DstIP</span>      <span class="kt">string</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nx">getDnsPcapHandle</span><span class="p">(</span><span class="nx">ip</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pcap</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">devs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pcap</span><span class="p">.</span><span class="nx">FindAllDevs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">device</span> <span class="kt">string</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">devs</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dev</span><span class="p">.</span><span class="nx">Addresses</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">IP</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span> <span class="o">==</span> <span class="nx">ip</span> <span class="p">{</span>
                <span class="nx">device</span> <span class="p">=</span> <span class="nx">dev</span><span class="p">.</span><span class="nx">Name</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">device</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">"find device error"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pcap</span><span class="p">.</span><span class="nx">OpenLive</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">pcap</span><span class="p">.</span><span class="nx">BlockForever</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"StartDnSMonitor"</span><span class="p">)</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">SetBPFFilter</span><span class="p">(</span><span class="s">"udp and port 53"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">StartDNSNetSniff</span><span class="p">(</span><span class="nx">resultChan</span> <span class="kd">chan</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">eth</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">Ethernet</span>
    <span class="kd">var</span> <span class="nx">ip4</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">IPv4</span>
    <span class="kd">var</span> <span class="nx">udp</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">UDP</span>
    <span class="kd">var</span> <span class="nx">dns</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">DNS</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">Payload</span>

    <span class="kd">var</span> <span class="nx">resultdata</span> <span class="p">=</span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getDnsPcapHandle</span><span class="p">(</span><span class="s">"10.10.16.1"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"get pcaphandle failed, err:"</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">parser</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">NewDecodingLayerParser</span><span class="p">(</span><span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeEthernet</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">eth</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ip4</span><span class="p">,</span><span class="o">&amp;</span><span class="nx">udp</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">dns</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">payload</span><span class="p">)</span>
    <span class="nx">decodedLayers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">gopacket</span><span class="p">.</span><span class="nx">LayerType</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">data</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">ReadPacketData</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"Error reading packet data: "</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">DecodeLayers</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">decodedLayers</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">typ</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">decodedLayers</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="nx">typ</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeIPv4</span><span class="p">:</span>
                <span class="nx">SrcIP</span> <span class="p">=</span> <span class="nx">ip4</span><span class="p">.</span><span class="nx">SrcIP</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
                <span class="nx">DstIP</span> <span class="p">=</span> <span class="nx">ip4</span><span class="p">.</span><span class="nx">DstIP</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
            <span class="k">case</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeDNS</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">!</span><span class="nx">dns</span><span class="p">.</span><span class="nx">QR</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dnsQuestion</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">Questions</span> <span class="p">{</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"source"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"dns"</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"src"</span><span class="p">]</span> <span class="p">=</span> <span class="nx">SrcIP</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"dst"</span><span class="p">]</span> <span class="p">=</span> <span class="nx">DstIP</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"domain"</span><span class="p">]</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">dnsQuestion</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"type"</span><span class="p">]</span> <span class="p">=</span> <span class="nx">dnsQuestion</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
                        <span class="nx">resultdata</span><span class="p">[</span><span class="s">"class"</span><span class="p">]</span> <span class="p">=</span> <span class="nx">dnsQuestion</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
                        <span class="nx">resultChan</span> <span class="o">&lt;-</span> <span class="nx">resultdata</span>

                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
  </div>
</article>
<div id="cyReward" role="cylabs" data-use="reward" style="text-align:center;"></div>
<!--PC和WAP自适应版-->
<div id="SOHUCS" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cysYUIjwy'; 
var conf = 'prod_71b5e53cad0d27b5ed44fa5219b069b5'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

<script type="text/javascript" charset="utf-8" src="https://changyan.itc.cn/js/lib/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="https://changyan.sohu.com/js/changyan.labs.https.js?appid=cysYUIjwy"></script>    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
       <ul class="col-sm-6 list-inline">
          <li class="list-inline-item"><a href="https://www.njcx.bid/authors.html">Authors</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/archives.html">Archives</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/categories.html">Categories</a></li>
          <li class="list-inline-item"><a href="https://www.njcx.bid/tags.html">Tags</a></li>
        </ul>
        <p class="col-sm-6 text-sm-right text-muted">
          本站由 <a href="https://github.com/getpelican/pelican" target="_blank">Pelican 生成</a> 后续 by <a href="https://github.com/njcx" target="_blank">nJcx</a>
        </p>
      </div>
    </div>
  </footer>
</body>

</html>